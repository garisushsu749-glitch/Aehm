
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق إعدادية المنصور الصناعية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">
    
    <!-- إضافة مكتبات التواصل الاجتماعي -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/ar_AR/sdk.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #6366f1; 
            --secondary-color: #8b5cf6; 
            --background-app: #ffffff; 
            --text-color: #1e293b; 
            --card-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); 
            --input-bg: #f8fafc; 
            --support-color: #f59e0b; 
            --transition-speed: 0.3s; 
            --background-body: linear-gradient(135deg, #eef2ff 0%, #f3e8ff 50%, #fef3c7 100%); 
            --glass-bg: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(99, 102, 241, 0.2); 
            /* متغيرات الألوان المخصصة */
            --custom-primary: var(--primary-color);
            --custom-bg: var(--background-app);
            --custom-text: var(--text-color);
        }
        .dark-mode { --background-body: #0a0a0a; --background-app: #1c1c1c; --text-color: #f1f1f1; --primary-color: #4db6ac; --secondary-color: #80deea; --input-bg: #2d2d2d; --card-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); --glass-bg: rgba(28, 28, 28, 0.7); --glass-border: rgba(255, 255, 255, 0.1); }

        /* تنسيقات عامة */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }

        body {
            background: var(--background-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            transition: background var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        
        /* ==================================== */
        /* 1. تنسيقات شاشة تسجيل الدخول */
        /* ==================================== */
        .login-container {
            width: 92%;
            max-width: 420px;
            padding: 40px 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 40px;
            box-shadow: 0 40px 80px -15px rgba(99, 102, 241, 0.3), 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            text-align: center;
            color: var(--text-color);
            border: 2px solid var(--glass-border);
            animation: fadeInScale 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            animation: rotateBg 15s linear infinite;
            z-index: -1;
        }
        @keyframes rotateBg {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .login-logo {
            font-size: 4.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            position: relative;
        }
        .barcode-logo {
            display: flex;
            gap: 3px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .barcode-line {
            width: 4px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: barcodeAnim 1.5s infinite ease-in-out;
        }
        @keyframes barcodeAnim {
            0%, 100% { height: 30px; opacity: 0.5; }
            50% { height: 50px; opacity: 1; }
        }
        .login-container h2 {
            font-size: 2.2rem;
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }
        .login-subtitle {
            color: #64748b;
            margin-bottom: 35px;
            font-size: 1rem;
            font-weight: 500;
        }
        .dark-mode .login-subtitle { color: #94a3b8; }
        .input-group { margin-bottom: 25px; text-align: right; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: 800; color: var(--text-color); font-size: 0.95rem; padding-right: 5px; }
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 18px 20px; 
            border: 2px solid transparent; 
            border-radius: 20px; 
            background-color: var(--input-bg); 
            font-size: 1.05rem; 
            color: var(--text-color); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            appearance: none;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }
        .input-group input:focus, .input-group select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            background-color: #fff; 
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.15), 0 4px 6px -2px rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }
        .dark-mode .input-group input:focus, .dark-mode .input-group select:focus { background-color: #2d2d2d; }
        .login-button { 
            width: 100%; 
            padding: 18px; 
            font-size: 1.25rem; 
            font-weight: 900; 
            margin-top: 20px; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            border-radius: 22px; 
            box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.5); 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: none; 
            letter-spacing: 0.5px;
        }
        .scan-button {
            width: 100%;
            padding: 14px;
            background: #f8fafc;
            color: var(--primary-color);
            border: 2px dashed var(--primary-color);
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .scan-button:hover { background: #eef2ff; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; margin-top: 15px; display: none; }
        .card-wrapper {
            perspective: 1000px;
            margin-top: 15px;
            width: 100%;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .student-card-inner {
            position: relative;
            width: 100%;
            height: 220px;
            text-align: right;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .card-wrapper:hover .student-card-inner {
            transform: rotateY(180deg);
        }
        .student-card-front, .student-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 20px;
            padding: 20px;
            color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            overflow: hidden;
        }
        .student-card-back {
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .student-card-front::before, .student-card-back::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        .student-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-logo { font-weight: 900; font-size: 1.2rem; }
        .card-chip { width: 40px; height: 30px; background: #ffd700; border-radius: 5px; opacity: 0.8; }
        .card-body { display: flex; gap: 15px; align-items: center; }
        .card-photo { width: 70px; height: 70px; border-radius: 12px; border: 2px solid white; object-fit: cover; }
        .card-info h3 { font-size: 1.1rem; margin: 0; color: white; }
        .card-info p { font-size: 0.8rem; opacity: 0.9; margin: 2px 0; color: white; }
        .card-footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .card-id { font-family: monospace; font-size: 1rem; letter-spacing: 2px; }
        .qr-mini { width: 40px; height: 40px; background: white; padding: 2px; border-radius: 4px; }
        .login-button:hover { 
            transform: translateY(-6px) scale(1.03); 
            box-shadow: 0 25px 50px -15px rgba(99, 102, 241, 0.7); 
        }
        .login-button:active { transform: translateY(-2px) scale(0.98); }
        #login-error-message { 
            background-color: #fee2e2;
            color: #dc2626; 
            font-weight: 700; 
            margin-top: 20px; 
            padding: 12px;
            border-radius: 12px;
            display: none; 
            font-size: 0.9rem;
            border: 1px solid #fecaca;
        }
        .dark-mode #login-error-message { background-color: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.2); }

        /* ==================================== */
        /* 2. تنسيقات التطبيق الرئيسية */
        /* ==================================== */

        .app-container {
            display: none; 
            width: 100%;
            max-width: 450px; 
            min-height: 100vh;
            background-color: var(--background-app);
            box-shadow: var(--card-shadow);
            padding: 30px 25px;
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
            position: relative;
        }

        /* رأس التطبيق والشعار */
        .app-header { 
            text-align: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--input-bg);
            position: relative; 
        }
        /* الشعار: رمز كتاب مفتوح */
        .app-header .app-logo {
            display: inline-block;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 4rem; /* حجم كبير للرمز */
            line-height: 1;
        }
        /* التعديل لجعل عنوان الإعدادية أكبر */
        .app-header h1 {
            font-size: 2.5rem; /* تم تكبير حجم الخط */
            font-weight: 900; 
            color: var(--primary-color);
        }

        /* ... (تنسيقات البحث لم تتغير) ... */
        .search-container { position: relative; margin-bottom: 30px; }
        #search-input, #main-search-input, #browser-search-input { width: 100%; padding: 15px 50px 15px 20px; border: 2px solid var(--input-bg); border-radius: 12px; background-color: var(--input-bg); font-size: 1rem; color: var(--text-color); transition: border-color var(--transition-speed); }
        #search-input:focus, #main-search-input:focus, #browser-search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2); }
        .search-container .search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: #999; font-size: 1.2rem; }
        .dark-mode .search-container .search-icon { color: #ccc; }


        /* أزرار الزاوية العلوية - تم تثبيتها بـ fixed وزيادة Z-index */
        .corner-button {
            position: fixed; /* تثبيت الزر في الشاشة */
            top: 20px;
            background: var(--input-bg); /* خلفية خفيفة */
            border: 1px solid var(--primary-color);
            border-radius: 50%;
            width: 50px; 
            height: 50px;
            cursor: pointer;
            padding: 0;
            transition: all var(--transition-speed) ease; /* تحديث الانتقال */
            z-index: 2000; /* قيمة عالية جداً لضمان الظهور فوق النوافذ المنبثقة */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 1.5rem; /* حجم الأيقونة/الإيموجي */
            line-height: 1;
        }
        .dark-mode .corner-button {
             background: #333;
             border-color: var(--secondary-color);
        }
        .corner-button:hover { 
            transform: scale(1.1); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        /* لإخفاء الزر بانتقال سلس */
        .corner-button.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(-20px);
        }


        #mode-toggle { right: 20px; }
        #profile-button { left: 20px; }

        /* ... (تنسيقات الأزرار الرئيسية والشبكة لم تتغير) ... */
        button { border: none; border-radius: 15px; cursor: pointer; transition: all var(--transition-speed) ease; }
        .main-button { background: linear-gradient(135deg, var(--primary-color), #004d40); color: white; height: 120px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0, 121, 107, 0.5); margin-bottom: 30px; display: flex; flex-direction: row; padding: 20px; justify-content: center; align-items: center; text-align: right; }
        .dark-mode .main-button { background: linear-gradient(135deg, var(--primary-color), #26a69a); box-shadow: 0 15px 35px rgba(77, 182, 172, 0.5); }
        .main-button .button-icon { font-size: 3.5rem; margin-left: 15px; }
        .main-button .button-text { font-size: 1.6rem; font-weight: 900; }
        .main-button:hover { transform: translateY(-3px) scale(1.02); }
        .grid-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .grid-button { background-color: #ffffff; color: var(--text-color); height: 110px; padding: 15px; border-radius: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); font-size: 0.95rem; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #f1f5f9; font-weight: 700; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .grid-button:hover { transform: translateY(-5px); border-color: var(--primary-color); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1); }
        .dark-mode .grid-button { background-color: #2a2a2a; box-shadow: 0 5px 15px rgba(255, 255, 255, 0.05); }
        .grid-button .button-icon { color: var(--primary-color); font-size: 2.2rem; margin-bottom: 5px; }
        .dark-mode .grid-button .button-icon { color: var(--secondary-color); }
        .grid-button .button-text { font-size: 0.95rem; line-height: 1.2; font-weight: 800; }


        
        /* ===== منبه وقت القراءة ===== */
        .reading-timer { position: fixed; top: 100px; right: 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 15px 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); z-index: 1001; display: none; min-width: 200px; animation: slideInRight 0.4s ease; }
        .reading-timer.active { display: block; }
        .reading-timer .timer-header { font-weight: 800; margin-bottom: 10px; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .reading-timer .close-timer { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0; }
        .reading-timer .timer-display { font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 10px; font-family: 'Courier New', monospace; }
        .reading-timer .timer-stats { font-size: 0.85rem; line-height: 1.6; border-top: 1px solid rgba(255, 255, 255, 0.3); padding-top: 10px; margin-bottom: 10px; }
        .reading-timer .timer-controls { display: flex; gap: 8px; }
        .reading-timer .timer-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background-color: rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-weight: 700; font-size: 0.8rem; }
        .reading-timer .timer-btn:hover { background-color: rgba(255, 255, 255, 0.3); }
        @keyframes slideInRight { from { transform: translateX(300px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .app-container { padding-bottom: 100px; }

        /* التذييل - الحقوق (محدث) */
        .credits { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.85rem; color: #777; text-align: right; line-height: 1.9; }
        .dark-mode .credits { border-top: 1px solid #333; color: #aaa; }
        .credits strong { color: var(--primary-color); display: block; margin-bottom: 5px; font-size: 1rem; }
        .credits .credit-line { display: block; margin-bottom: 3px; }

        /* ==================================== */
        /* ==================================== */
        /* تنسيقات النوافذ المنبثقة (Modal) */
        /* ==================================== */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px); 
        }
        /* تعديل خاص لنافذة القارئ لجعلها تملأ الشاشة بالكامل */
        #bookReader {
            background-color: var(--background-app); /* خلفية التطبيق */
            z-index: 2000; /* فوق كل شيء */
            padding: 0;
        }

        .modal-content { 
            background-color: var(--glass-bg); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 30px; 
            border-radius: 30px; 
            width: 92%; 
            max-width: 450px; 
            box-shadow: var(--card-shadow); 
            color: var(--text-color); 
            position: relative; 
            transform: scale(0.9); 
            animation: modal-open 0.3s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            max-height: 90vh; 
            overflow-y: auto; 
            border: 1px solid var(--glass-border);
        }
        /* تنسيق خاص لمحتوى القارئ */
        #bookReader .modal-content {
             max-width: 100%;
             max-height: 100%;
             width: 100%;
             height: 100%;
             padding: 0;
             border-radius: 0;
             box-shadow: none;
             overflow: hidden; /* إخفاء شريط التمرير من المحتوى */
        }
        /* تنسيق iframe القارئ */
        #book-iframe {
            width: 100%;
            height: calc(100% - 70px); /* عرض الإطار بحجم الشاشة - ارتفاع الهيدر */
            border: none;
            display: block;
            background-color: #e0f7fa;
        }
        #bookReader .header-reader {
             display: flex;
             justify-content: space-between;
             align-items: center;
             height: 70px;
             padding: 0 20px;
             border-bottom: 1px solid var(--input-bg);
        }
        #bookReader .header-reader h2 {
             font-size: 1.4rem;
             color: var(--primary-color);
             margin: 0;
             padding: 0;
             border-bottom: none;
        }


        @keyframes modal-open { to { transform: scale(1); } }
        .modal-content h2 { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 25px; font-size: 1.6rem; display: flex; align-items: center; }
        .modal-content .close-button { position: absolute; top: 15px; left: 15px; color: var(--text-color); font-size: 30px; font-weight: 300; background: none; width: auto; height: auto; line-height: 1; padding: 0; cursor: pointer; }
        .modal-content .close-button:hover { color: var(--secondary-color); }
        
        #bookReader .close-button {
             position: static; /* إزالة التثبيت */
             color: #dc3545; /* لون أحمر للإغلاق */
             font-size: 1.2rem;
             padding: 10px 15px;
             background-color: var(--input-bg);
             border-radius: 10px;
        }
        #bookReader .close-button:hover {
            background-color: #eee;
        }
        .dark-mode #bookReader .close-button:hover {
            background-color: #3a3a3a;
        }
        
        .back-button { background-color: #dc3545; color: white; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-size: 1.05rem; font-weight: 700; display: block; width: 100%; text-align: center; box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4); }
        .stage-list, .subject-list { list-style-type: none; padding: 0; }
        .stage-item, .subject-item { padding: 18px; margin-bottom: 12px; background-color: var(--input-bg); border-radius: 15px; cursor: pointer; transition: all var(--transition-speed); display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: var(--text-color); border-right: 5px solid var(--primary-color); }
        .dark-mode .stage-item, .dark-mode .subject-item { border-right: 5px solid var(--secondary-color); }
        .stage-item:hover, .subject-item:hover { background-color: #f0f0f0; transform: translateX(-8px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); }
        .dark-mode .stage-item:hover, .dark-mode .subject-item:hover { background-color: #3a3a3a; transform: translateX(-8px); box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1); }
        .subject-details { font-size: 0.85rem; color: #6c757d; margin-top: 5px; font-weight: 400; display: block; }
        .dark-mode .subject-details { color: #ccc; }
        .favorite-toggle { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.5rem; color: #ccc; transition: color 0.3s; margin-left: 10px; }
        .favorite-toggle.is-favorite { color: #dc3545; }
        
        #support-fab { 
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            z-index: 1002; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background-color: var(--support-color); 
            color: var(--text-color); 
            border: none; 
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.6); 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.8rem; 
            transition: all var(--transition-speed) ease; /* تحديث الانتقال */
        }
        #support-fab.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(20px);
        }

        #support-fab:hover { transform: scale(1.1); box-shadow: 0 10px 25px rgba(255, 193, 7, 0.8); }
        #support-fab .fab-icon { color: #3e2723; }

        #notif-fab { 
            position: fixed; 
            bottom: 90px; 
            left: 20px; 
            z-index: 1002; 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.8rem; 
            transition: all var(--transition-speed) ease;
        }
        #notif-fab.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(20px);
        }
        #notif-fab:hover { transform: scale(1.1); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.6); }
        #notif-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            display: none;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
        }
        .notif-item {
            padding: 15px;
            border-bottom: 1px solid var(--input-bg);
            position: relative;
            transition: background 0.3s;
        }
        .notif-item:last-child { border-bottom: none; }
        .notif-item.unread { background-color: rgba(99, 102, 241, 0.05); }
        .notif-item .notif-time { font-size: 0.75rem; color: #777; margin-top: 5px; }
        .notif-item .notif-title { font-weight: 800; color: var(--primary-color); margin-bottom: 5px; }
        
        /* ==================================== */
        /* تنسيقات صندوق الدردشة بالذكاء الاصطناعي (جديد) */
        /* ==================================== */
        #ai-chat-box {
            background-color: var(--input-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--secondary-color); /* إطار للتمييز */
        }
        .dark-mode #ai-chat-box {
            border: 1px solid var(--primary-color);
        }
        
        #ai-chat-box h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-weight: 800;
            display: flex;
            align-items: center;
        }
        
        #ai-chat-box .ai-prompt-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            background-color: var(--background-app);
            color: var(--text-color);
            border: 2px solid var(--input-bg);
        }
        .dark-mode #ai-chat-box .ai-prompt-input {
             border: 1px solid #444;
        }

        #ai-chat-box .ai-prompt-input:focus {
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2);
        }
        
        .ai-chat-button {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--secondary-color), #00a0b2);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 188, 212, 0.4);
        }
        
        .ai-chat-button:hover {
            transform: translateY(-1px);
        }
        
        .ai-response-area {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background-app);
            border-radius: 10px;
            border-left: 5px solid var(--primary-color);
            line-height: 1.7;
            font-size: 0.95rem;
            max-height: 250px;
            overflow-y: auto;
            color: var(--text-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .dark-mode .ai-response-area {
            border-left: 5px solid var(--secondary-color);
        }
        
        /* ... (تنسيقات support-contact-info, content-box, setting-option لم تتغير) ... */
        .support-contact-info li { padding: 15px; margin-bottom: 10px; background-color: var(--input-bg); border-radius: 10px; cursor: pointer; transition: var(--transition-speed); display: flex; align-items: center; font-weight: 700; }
        .support-contact-info li:hover { background-color: #eee; transform: translateX(-5px); }
        .dark-mode .support-contact-info li:hover { background-color: #3a3a3a; }
        .support-contact-info .icon { font-size: 1.5rem; margin-left: 10px; color: var(--primary-color); }
        .content-box { padding: 15px; background-color: var(--input-bg); border-radius: 10px; margin-bottom: 15px; line-height: 1.6; }
        .content-box h4 { color: var(--secondary-color); margin-bottom: 10px; font-weight: 800; }
        .setting-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #ccc; }
        .dark-mode .setting-option { border-bottom: 1px dashed #444; }
        .setting-option:last-child { border-bottom: none; }
        .switch { position: relative; display: inline-block; width: 45px; height: 25px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 25px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 3.5px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(18px); }
        .profile-info h3 { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; }
        .profile-image-container { position: relative; width: 120px; height: 120px; margin: 0 auto 25px; border-radius: 50%; border: 4px solid var(--primary-color); padding: 3px; background: var(--background-app); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .profile-image-container img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .profile-image-container:hover img { transform: scale(1.1) rotate(5deg); }
        @keyframes pulse-avatar { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .profile-image-container .upload-hint { position: absolute; bottom: 0; right: 0; background: var(--secondary-color); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid var(--background-app); font-size: 1.2rem; transition: transform 0.3s; }
        .profile-image-container .upload-hint:hover { transform: scale(1.1); }
        .profile-detail { background-color: var(--input-bg); padding: 15px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: 700; transition: transform 0.3s; }
        .profile-detail:hover { transform: scale(1.02); }
        .profile-detail span:last-child { color: var(--secondary-color); font-weight: 800; }
        .logout-button { width: 100%; margin-top: 30px; padding: 15px; font-size: 1.1rem; font-weight: 800; background-color: #dc3545; color: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(220, 53, 69, 0.5); }
        .logout-button:hover { background-color: #c82333; transform: translateY(-2px); }
        .favorite-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background-color: var(--input-bg); border-radius: 10px; font-weight: 700; border-right: 5px solid #dc3545; transition: all 0.3s; }
        .favorite-list-item:hover { background-color: #f0f0f0; transform: translateX(-5px); }
        .dark-mode .favorite-list-item:hover { background-color: #3a3a3a; }
        .remove-favorite { background: none; border: none; color: #dc3545; font-weight: 800; cursor: pointer; font-size: 1rem; margin-left: 10px; }
        .remove-favorite:hover { text-decoration: underline; }

        /* تنسيقات نافذة الانذارات والغيابات */
        #shared-warnings-list { list-style-type: none; padding: 0; margin-top: 20px; }
        #shared-warnings-list .stage-item { border-right: 5px solid #dc3545; /* لون أحمر للإنذارات */ }
        #shared-warnings-list .stage-item:hover { transform: translateX(-5px); }
        #admin-actions { border-top: 1px solid var(--input-bg); padding-top: 20px; margin-top: 20px; }
        #admin-actions h4 { color: #dc3545; margin-bottom: 15px; }


        /* تنسيقات ميزة التدريب على الرسم الهندسي */
        .drawing-board-container {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f0e6d2; /* لون خشبي فاتح للبورد */
            border: 10px solid #8d6e63;
            border-radius: 10px;
            overflow: hidden;
            cursor: crosshair;
            touch-action: none;
        }
        #drawingCanvas {
            width: 100%;
            height: 100%;
        }
        .t-square {
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 10;
        }
        .t-square::before {
            content: '';
            position: absolute;
            left: 0;
            top: -20px;
            width: 40px;
            height: 44px;
            background-color: #333;
        }
        .drawing-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .draw-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
        }

        /* ==================================== */
        /* تنسيقات نافذة تدريب الرسم المنبثقة */
        /* ==================================== */

        .drawing-training-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .drawing-training-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .drawing-training-modal-content {
            background-color: var(--background-app);
            padding: 40px 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 550px;
            box-shadow: var(--card-shadow);
            position: relative;
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .drawing-training-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-color);
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: all var(--transition-speed) ease;
            background-color: var(--input-bg);
        }

        .drawing-training-modal-close:hover {
            background-color: var(--primary-color);
            color: white;
            transform: rotate(90deg);
        }

        .drawing-training-modal-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }

        .drawing-training-modal-header .icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .drawing-training-modal-header h2 {
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 900;
            margin-bottom: 10px;
        }

        .drawing-training-modal-header p {
            color: var(--text-color);
            font-size: 1rem;
            opacity: 0.8;
        }

        .drawing-training-modal-body {
            margin-bottom: 30px;
        }

        .drawing-training-section {
            margin-bottom: 25px;
        }

        .drawing-training-section h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            font-weight: 800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawing-training-section h3 .section-icon {
            font-size: 1.5rem;
        }

        .drawing-training-section p {
            color: var(--text-color);
            line-height: 1.8;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .drawing-training-section .instructor-name {
            background-color: var(--input-bg);
            padding: 15px;
            border-right: 4px solid var(--primary-color);
            border-radius: 8px;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .tools-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tools-table thead {
            background-color: var(--primary-color);
            color: white;
        }

        .tools-table th {
            padding: 12px;
            text-align: right;
            font-weight: 800;
            font-size: 0.95rem;
        }

        .tools-table td {
            padding: 12px;
            border-bottom: 1px solid var(--input-bg);
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .tools-table tbody tr:hover {
            background-color: var(--input-bg);
            transition: background-color var(--transition-speed) ease;
        }

        .tools-table .tool-number {
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
        }

        .tools-table .tool-name {
            font-weight: 700;
            color: var(--primary-color);
        }

        .important-note {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1), rgba(0, 188, 212, 0.1));
            border-right: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .important-note .note-icon {
            font-size: 1.5rem;
            margin-left: 10px;
            vertical-align: middle;
        }

        .important-note p {
            color: var(--text-color);
            line-height: 1.7;
            margin: 0;
        }

        .drawing-training-modal-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--input-bg);
        }

        .drawing-training-modal-footer button {
            background: linear-gradient(135deg, var(--primary-color), #004d40);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 121, 107, 0.4);
            transition: all var(--transition-speed) ease;
        }

        .drawing-training-modal-footer button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 121, 107, 0.6);
        }

        .drawing-training-modal-footer button:active {
            transform: translateY(0);
        }

        .dark-mode .tools-table tbody tr:hover {
            background-color: #2a2a2a;
        }

        .dark-mode .drawing-training-modal-close {
            background-color: #2d2d2d;
        }

        @media (max-width: 600px) {
            .drawing-training-modal-content {
                width: 95%;
                padding: 30px 20px;
            }

            .drawing-training-modal-header h2 {
                font-size: 1.6rem;
            }

            .drawing-training-section h3 {
                font-size: 1.1rem;
            }

            .tools-table th,
            .tools-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .drawing-training-modal-close {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
            }
        }
        
        .developer-link { 
            color: #007bff; /* لون أزرق */
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s;
        }
        .developer-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
    
    
        /* ==================================== */
        /* شاشة الترحيب (Splash Screen) المحدثة */
        /* ==================================== */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .dark-mode #splash-screen {
            background: #0a0a0a;
        }
        .splash-logo {
            width: 100px;
            height: 100px;
            background: #00796b;
            border-radius: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3.5rem;
            box-shadow: 0 15px 35px rgba(0, 121, 107, 0.3);
            margin-bottom: 25px;
            animation: pulse 2s infinite ease-in-out;
        }
        .splash-title {
            font-size: 1.6rem;
            font-weight: 900;
            color: #00796b;
            margin-bottom: 30px;
        }
        
        /* تصميم شريط التقدم كما في الصورة */
        .progress-container {
            width: 70%;
            max-width: 300px;
            height: 6px;
            background-color: rgba(128, 128, 128, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #007bff; /* لون أزرق كما في الصورة */
            border-radius: 10px;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }


        /* ==================================== */
        /* تنسيقات ميزة التقييم والشكاوى */
        /* ==================================== */
        .rating-container {
            text-align: center;
            padding: 10px 0;
        }
        .stars {
            display: flex;
            justify-content: center;
            flex-direction: row-reverse;
            margin-bottom: 20px;
        }
        .stars input { display: none; }
        .stars label {
            font-size: 2.5rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0 5px;
        }
        .stars label:before { content: '★'; }
        .stars input:checked ~ label { color: #ffc107; }
        .stars label:hover, .stars label:hover ~ label { color: #ffdb70; }

        .complaint-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid var(--input-bg);
            border-radius: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .complaint-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .send-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0088cc, #005588);
            color: white;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
            border: none;
            cursor: pointer;
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
        }
        .send-btn svg { width: 24px; height: 24px; }

        /* تنسيقات أزرار التواصل الاجتماعي */
        .social-login { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
        .social-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; border: 1px solid #ddd; background: white; color: #333; font-size: 0.9rem; }
        .social-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .facebook-btn { border-color: #1877F2; background: #1877F2; color: white; }
        .divider { margin: 20px 0; display: flex; align-items: center; text-align: center; color: #888; font-size: 0.8rem; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
        .divider:not(:empty)::before { margin-right: .5em; }
        .divider:not(:empty)::after { margin-left: .5em; }
        .share-btn-floating { position: fixed; bottom: 100px; left: 20px; background: var(--primary-color); color: white; width: 50px; height: 50px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; transition: all 0.3s ease; font-size: 1.5rem; }
        .share-btn-floating:hover { transform: scale(1.1); }

        /* تنسيقات نظام الإشعارات */
        .notification-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--primary-color); border-radius: 20px; padding: 15px 20px; box-shadow: var(--card-shadow); z-index: 9999; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; gap: 15px; }
        .notification-toast.show { top: 20px; }
        .notification-icon { font-size: 1.8rem; background: var(--primary-color); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
        .notification-content { flex-grow: 1; }
        .notification-title { font-weight: 900; font-size: 1rem; color: var(--primary-color); margin-bottom: 2px; }
        .notification-message { font-size: 0.85rem; color: var(--text-color); line-height: 1.4; }
        .notification-close { cursor: pointer; font-size: 1.2rem; color: #888; }

    </style>
</head>
<body>
    <!-- شاشة الترحيب -->
    <!-- نظام الإشعارات المنبثقة -->
    <div id="notification-toast" class="notification-toast">
        <div class="notification-icon" id="notif-icon">🔔</div>
        <div class="notification-content">
            <div class="notification-title" id="notif-title">إشعار جديد</div>
            <div class="notification-message" id="notif-message">مرحباً بك في تطبيق إعدادية المنصور!</div>
        </div>
        <div class="notification-close" onclick="hideNotification()">×</div>
    </div>

    <div id="splash-screen">
        <div class="splash-logo">📖</div>
        <div class="splash-title">إعدادية المنصور الصناعية</div>
        <div class="progress-container">
            <div class="progress-bar" id="main-progress-bar"></div>
        </div>
    </div>



    <div class="login-container" id="login-screen">
        <div class="barcode-logo">
            <div class="barcode-line" style="animation-delay: 0.1s"></div>
            <div class="barcode-line" style="animation-delay: 0.3s"></div>
            <div class="barcode-line" style="animation-delay: 0.5s"></div>
            <div class="barcode-line" style="animation-delay: 0.2s"></div>
            <div class="barcode-line" style="animation-delay: 0.4s"></div>
            <div class="barcode-line" style="animation-delay: 0.6s"></div>
        </div>
        <div class="login-logo" onclick="openModal('adminPanel')" style="cursor: pointer;" title="لوحة التحكم">🎓</div>
        <h2>إعدادية المنصور</h2>
        <p class="login-subtitle">مرحباً بك في منصتك التعليمية المتكاملة</p>

        <!-- أزرار التواصل الاجتماعي -->
        <div class="social-login">
            <button class="social-btn" style="border-color: #4285F4; background: #4285F4; color: white;" onclick="loginWithGoogle()">
                <span style="font-size: 1.2rem;">🔍</span> التسجيل بواسطة جوجل
            </button>

            <button class="social-btn facebook-btn" onclick="loginWithFacebook()">
                <span style="font-size: 1.2rem;">🔵</span> التسجيل بواسطة فيسبوك
            </button>
        </div>

        <div class="divider">أو عبر الهوية الرقمية</div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="scan-button" onclick="toggleScanner()" style="flex: 1; margin-top: 0;">
                <span>📷</span> مسح الهوية
            </button>
            <button class="scan-button" onclick="document.getElementById('qr-input-file').click()" style="flex: 1; margin-top: 0; border-style: solid; background: #eef2ff;">
                <span>🖼️</span> رفع صورة
            </button>
        </div>
        <input type="file" id="qr-input-file" accept="image/*" style="display: none;" onchange="scanFile(this)">
        <div id="reader"></div>

        <div class="divider">أو عبر البيانات اليدوية</div>
        
        <div class="input-group">
            <label for="studentName">اسم الطالب:</label>
            <input type="text" id="studentName" placeholder="أدخل اسمك الكريم" required>
        </div>
        
        <div class="input-group">
            <label for="studentSection">اختر القسم:</label>
            <select id="studentSection" required>
                <option value="" disabled selected>-- اختر قسمك --</option>
                <option value="elec">قسم الكهرباء</option>
                <option value="elecs">قسم الإلكترونيك والسيطرة</option>
                <option value="media">قسم تكنولوجيا الإعلام</option>
                <option value="med">قسم الأجهزة الطبية</option>
            </select>
        </div>

        <div class="input-group">
            <label for="studentStage">اختر المرحلة:</label>
            <select id="studentStage" required>
                <option value="" disabled selected>-- اختر مرحلتك --</option>
                <option value="1">الأول المهني</option>
                <option value="2">الثاني المهني</option>
                <option value="3">الثالث المهني</option>
            </select>
        </div>
        
        <div class="input-group">
            <label for="studentEmail">البريد الإلكتروني:</label>
            <input type="email" id="studentEmail" placeholder="example@gmail.com" required>
        </div>

        <div class="input-group">
            <label for="studentPassword">كلمة المرور:</label>
            <input type="password" id="studentPassword" placeholder="كلمة المرور" required>
        </div>
        
        <p id="login-error-message" style="color: #dc3545; font-weight: 700; margin-top: 15px; display: none;">الرجاء ملء جميع الحقول للمتابعة.</p>
        
        <button class="login-button" onclick="attemptLogin()">
            تسجيل الدخول والبدء
        </button>
        
        <div class="credits" style="margin-top: 30px; border-top: none;">
            <span style="display: block; font-size: 0.9rem; color: #777;">للدخول، أدخل اسمك الثلاثي باللغة العربية، واختَر القسم والمرحلة.</span>
        </div>
        
        <div style="margin-top: 25px; text-align: center; padding: 15px; background: rgba(99, 102, 241, 0.05); border-radius: 15px; border: 1px solid rgba(99, 102, 241, 0.2);">
            <p style="color: #666; font-size: 0.95rem; margin: 0;">هل لديك حساب بالفعل؟</p>
            <p style="color: var(--primary-color); font-weight: 700; margin: 8px 0 0 0; font-size: 0.9rem;">استخدم نفس بيانات تسجيلك السابق للدخول</p>
        </div>
    </div>
    
    
    <button id="mode-toggle" class="corner-button hidden" aria-label="تبديل الوضع" style="display: none;">
        <span id="mode-icon">🌙</span> 
    </button>
    
    <button id="profile-button" class="corner-button hidden" aria-label="الحساب الشخصي" style="display: none;" onclick="openModal('userProfile')">
        <span>👤</span>
    </button>

    <div class="app-container" id="main-app-container">
        
        <header class="app-header">
             <div class="app-logo" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); width: 80px; height: 80px; border-radius: 22px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); transform: rotate(-5deg); transition: transform 0.3s;">
                <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V5H6.5A2.5 2.5 0 0 0 4 7.5v12z"></path></svg>
            </div>
            <h1>إعدادية المنصور الصناعية</h1>
        </header>

        <main class="main-content">
            
            <div class="search-container">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </span>
                <input type="text" id="main-search-input" placeholder="البحث في المواد، الأقسام، والمراحل..." oninput="syncSearchInput()">
            </div>
            
            <button class="main-button" onclick="openModal('stagesBrowser')">
                <div class="button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V5H6.5A2.5 2.5 0 0 0 4 7.5v12z"></path></svg>
                </div>
                <span class="button-text">تصفح الأقسام والمراحل</span>
            </button>

            <div class="grid-buttons">

                <button class="grid-button" onclick="openDrawingTrainingModal(); openModal('drawingTraining'); initDrawingBoard();">
                    <span class="button-icon">📐</span>
                    <span class="button-text">تدريب الرسم الهندسي</span>
                </button>
                    <button class="grid-button" onclick="openModal('myFavorites')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="var(--primary-color)" stroke="var(--primary-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </span>
                    <span class="button-text">مفضلتي</span>
                </button>
                
                 <button class="grid-button" onclick="openModal('warningsPunishments')">
                    <span class="button-icon" style="color: #dc3545;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    </span>
                    <span class="button-text">الإنذارات والغيابات</span>
                </button>
                <button class="grid-button" onclick="openModal('settings')">
                     <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </span>
                    <span class="button-text">الإعدادات</span>
                </button>
                <button class="grid-button" onclick="openModal('importantAdds')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 16h-.01M11 7h2v7h-2V7z"/></svg>
                    </span>
                    <span class="button-text">إضافات هامة</span>
                </button>
                <button class="grid-button" onclick="openModal('digitalReader')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="9" y2="9"></line></svg>
                    </span>
                    <span class="button-text">قارئ الدرس الرقمي</span>
                </button>
                <button class="grid-button" onclick="openModal('usageGuide')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </span>
                    <span class="button-text">شرح الإستخدام</span>
                </button>
                <button class="grid-button" onclick="openModal('supportShare')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10M12 24v-6M9 21h6"/></svg>
                    </span>
                    <span class="button-text">دعم ونشر التطبيق</span>
                </button>
                <button class="grid-button" onclick="openModal('calculator')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="6" y="4" width="12" height="4"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
                    </span>
                    <span class="button-text">الآلة الحاسبة</span>
                </button>
                <button class="grid-button" onclick="openModal('notepad')">
                    <span class="button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </span>
                    <span class="button-text">سجل الملاحظات</span>
                </button>
            </div>
            
            <!-- قسم التقييمات والشكاوى - نقل إلى أسفل المنتصف -->
            <div style="margin-top: 40px; padding: 25px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08)); border-radius: 20px; border: 2px solid rgba(99, 102, 241, 0.15); text-align: center;">
                <div style="font-size: 2.5rem; margin-bottom: 15px;">⭐</div>
                <h3 style="color: var(--primary-color); margin: 0 0 10px 0; font-size: 1.3rem;">شارك رأيك معنا</h3>
                <p style="color: #666; margin: 0 0 20px 0; font-size: 0.95rem;">نقدّر آراؤك واقتراحاتك لتحسين التطبيق بشكل مستمر</p>
                <button class="login-button" style="width: 100%; padding: 15px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));" onclick="openModal('ratingModal')">
                    📝 أرسل تقييمك والشكاوى
                </button>
            </div>
            
        
        <div class="credits" style="background: var(--input-bg); padding: 20px; border-radius: 20px; margin-top: 30px; border: 1px solid var(--glass-border);">
            <strong style="color: var(--primary-color); font-size: 1.1rem; margin-bottom: 10px; display: block;">حقوق النشر © 2025-2026</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: right;">
                <span class="credit-line">🏗️ إشراف: <strong>المهندسه مياس حارث</strong></span>
                <span class="credit-line">💻 مبرمج: <strong>أيهم فراس</strong></span>
                <span class="credit-line">🎨 مصمم: <strong>احمد عباس</strong></span>
                <span class="credit-line">🤝 مساعد 1: <strong>حسين علي دنيف</strong></span>
                <span class="credit-line">🛠️ مساعد 2: <strong>حسين عادل</strong></span>
            </div>
        </div>
    
    </main>
        
        <footer class="credits" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--primary-color);">
            <span class="credit-line" style="font-weight: 900; color: var(--secondary-color); font-size: 1rem;">قسم الإلكترونيك والسيطرة</span>
            <div style="font-size: 0.85rem; margin-top: 5px; opacity: 0.8;">إعدادية المنصور الصناعية - بغداد</div>
        </footer>
    </div>
    
    <button id="support-fab" class="hidden" onclick="openModal('technicalSupport')">
        <span class="fab-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3e2723" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 15h7A4.5 4.5 0 0 0 20 10.5C20 8 16.82 5.56 12 5.56 7.18 5.56 4 8 4 10.5A4.5 4.5 0 0 0 8.5 15z"></path><path d="M10 18v1a2 2 0 1 0 4 0v-1"></path><path d="M12 22v-3"></path></svg>
        </span>
    </button>

    <button id="notif-fab" class="hidden" onclick="openNotificationsModal()">
        <span class="fab-icon">🔔</span>
        <span id="notif-badge">0</span>
    </button>

    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('notificationsModal')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">🔔</span> مركز الإشعارات</h2>
            <div id="notifications-list" class="content-box" style="padding: 0; max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; padding: 20px; color: #777;">لا توجد إشعارات حالياً.</p>
            </div>
            <button class="logout-button" style="width: 100%; margin-top: 15px; background: #6c757d;" onclick="clearNotifications()">مسح جميع الإشعارات</button>
        </div>
    </div>
    
    
    <div id="userProfile" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('userProfile')">&times;</span>
            <h2 style="justify-content: center; border-bottom: none; margin-bottom: 15px;">حسابي الشخصي</h2>
            
            <div class="profile-info">
                <div class="profile-image-container">
                    <img id="profile-img-display" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" alt="Profile">
                    <div style="position: absolute; bottom: 0; right: 0; display: flex; gap: 5px;">
                        <label for="profile-img-input" class="upload-hint" title="رفع صورة">🖼️</label>
                        <div class="upload-hint" onclick="startCamera()" title="التقاط صورة" style="position: static;">📷</div>
                    </div>
                    <input type="file" id="profile-img-input" accept="image/*" style="display: none;" onchange="handleProfileImage(this)">
                </div>
                <div id="camera-container" style="display: none; margin-bottom: 15px;">
                    <video id="video" width="100%" autoplay style="border-radius: 15px; background: #000;"></video>
                    <button class="login-button" onclick="takeSnapshot()" style="margin-top: 10px; background: var(--secondary-color);">التقاط الآن</button>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div class="profile-detail">
                    <span>اسم المستخدم:</span>
                    <span id="profile-name">--</span>
                </div>
                <div class="profile-detail">
                    <span>القسم الدراسي:</span>
                    <span id="profile-section">--</span>
                </div>
                <div class="profile-detail">
                    <span>المرحلة الدراسية:</span>
                    <span id="profile-stage">--</span>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px; font-size: 1rem; color: var(--primary-color);">هوية الطالب الرقمية</h3>
            <div id="student-card-container">
                <!-- سيتم توليد الهوية هنا -->
            </div>
            <button class="login-button" style="margin-top: 15px; background: #10b981; font-size: 1rem; padding: 12px;" onclick="downloadIDCard()">
                📥 تحميل بطاقة الهوية كصورة
            </button>
            
            <button class="logout-button" onclick="logout()">
                تسجيل الخروج
            </button>
            
            <p style="text-align: center; margin-top: 20px; font-size: 0.85rem; color: #777;">
                * لتغيير معلوماتك، يرجى تسجيل الخروج وإعادة الدخول بالبيانات الجديدة.
            </p>
        </div>
    </div>

    <div id="warningsPunishments" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('warningsPunishments')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: #dc3545; margin-left: 10px;">⚠️</span> الإنذارات والغيابات (سجل مشترك)</h2>
            
            <div class="content-box">
                <h4>ملاحظة هامة:</h4>
                <p>هذا السجل يظهر الإنذارات الرسمية وحالات الغياب المسجلة من قبل الإدارة. يرجى الاطلاع عليه دورياً.</p>
            </div>
            
            <ul id="shared-warnings-list" class="stage-list">
                <li class="stage-item">
                    <span>الطالب: أحمد سعيد (غ. م.)</span>
                    <span style="color: #dc3545;">سجل: غياب غير مبرر</span>
                </li>
                 <li class="stage-item">
                    <span>الطالب: علي محمود (إنذار)</span>
                    <span style="color: #dc3545;">سجل: مخالفة للزي المدرسي</span>
                </li>
                <li class="stage-item">
                    <span>الطالب: محمد جاسم (غ. م.)</span>
                    <span style="color: #dc3545;">سجل: غياب غير مبرر 3 أيام</span>
                </li>
                 <li class="stage-item">
                    <span>الطالب: ايهم فراس جمال (إنذار)</span>
                    <span style="color: #dc3545;">سجل: إنذار رقم 1 (تأخير)</span>
                </li>
            </ul>
            
            <div id="admin-actions">
                 <h4 style="color: var(--secondary-color); margin-bottom: 10px;">لإدارة السجلات (للكادر فقط):</h4>
                 <div class="input-group">
                    <label for="admin-search-student-name">اسم الطالب المراد إضافة سجل له:</label>
                    <input type="text" id="admin-search-student-name" placeholder="أدخل اسم الطالب بالكامل">
                </div>
                <p id="admin-search-result" style="color: #dc3545; font-weight: 700; margin-top: 10px; display: none;">الرجاء إدخال اسم الطالب للبحث.</p>
                <button class="login-button" style="background: linear-gradient(135deg, #00bcd4, #0077b5); margin-top: 15px;" onclick="searchAndEditAbsences()">
                    بحث وإضافة سجل جديد
                </button>
            </div>
        </div>
    </div>
    <div id="technicalSupport" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('technicalSupport')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--secondary-color); margin-left: 10px;">🧠</span> المساعد الذكي والدعم الفني</h2>
            
            <div id="ai-chat-box">
                <h4><span style="margin-left: 10px;">🤖</span> مساعدك الذكي لحل الأسئلة!</h4>
                <p style="margin-bottom: 15px; font-size: 0.9rem; color: #6c757d;">اكتب سؤالك في أي مادة، وسأساعدك في الحل والشرح.</p>
                <input type="text" id="ai-prompt-input" class="ai-prompt-input" placeholder="مثال: اشرح نظرية الكهرومغناطيسية" onkeyup="if(event.keyCode == 13) getAIResponse()">
                <button class="ai-chat-button" onclick="getAIResponse()">
                    إرسال السؤال
                </button>
                <div id="ai-response-area" class="ai-response-area" style="display:none;">
                    <p style="font-weight: 700; color: var(--primary-color);">رد المساعد الذكي:</p>
                    <p id="ai-response-text">...</p>
                </div>
            </div>
            
            <p style="margin-bottom: 15px; font-weight: 700; border-top: 1px solid var(--input-bg); padding-top: 15px;">للدعم الفني والتواصل البشري:</p>
            <ul class="support-contact-info" style="list-style-type: none; padding: 0;">
                <li onclick="alert('فتح رابط التليجرام للمبرمج')">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </span>
                    التواصل عبر التيليجرام (المبرمج)
                </li>
            </ul>
        </div>
    </div>
    
    <div id="stagesBrowser" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('stagesBrowser')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">📚</span> تصفح الأقسام والمواد</h2>
            
             <div class="search-container" style="margin-bottom: 20px;">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </span>
                <input type="text" id="browser-search-input" placeholder="ابحث في أقسام ومواد الإعدادية...">
            </div>

            <div id="sections-container">
                <ul class="stage-list">
                    </ul>
            </div>
            
            <div id="stages-by-section-container" style="display: none;">
                <h3 id="section-stages-title" style="margin-bottom: 20px; color: var(--secondary-color);"></h3>
                <button class="back-button" onclick="showSections()">رجوع للأقسام</button>
                <ul id="stages-list-by-section" class="stage-list">
                    </ul>
            </div>
            
            <div id="books-container" style="display: none;">
                <h3 id="stage-title" style="margin-bottom: 20px; color: var(--secondary-color);"></h3>
                <button class="back-button">رجوع للمراحل</button>
                <a id="section-link" target="_blank" style="margin-bottom: 20px; display: none; color: white; background-color: #3f51b5; padding: 10px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: 700;">
                    قناة القسم الرسمية على تيليجرام
                </a>
                <ul id="subjects-list" class="subject-list">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="myFavorites" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('myFavorites')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: #dc3545; margin-left: 10px;">💖</span> مفضلتي</h2>
            
            <ul id="favorites-list">
                </ul>
            
            <p id="empty-favorites" style="text-align: center; margin-top: 30px; color: #777; font-weight: 700;">
                قائمة المفضلة فارغة. أضف المواد التي تحتاجها للوصول السريع!
            </p>
        </div>
    </div>
    
    <div id="settings" class="modal">
         <div class="modal-content">
            <span class="close-button" onclick="closeModal('settings')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">⚙️</span> الإعدادات</h2>

            <div class="content-box">
                <h4>خيارات العرض والألوان</h4>
                <div class="setting-option">
                    <span>الوضع الداكن تلقائي</span>
                    <label class="switch">
                      <input type="checkbox" id="autoDarkMode" onclick="toggleDarkMode()">
                      <span class="slider"></span>
                    </label>
                </div>
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--input-bg);">
                <div class="setting-option">
                    <span>لون التطبيق الأساسي</span>
                    <input type="color" id="primaryColorPicker" onchange="updateCustomColors()" style="width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer;">
                </div>
                <div class="setting-option">
                    <span>لون الخلفية</span>
                    <input type="color" id="bgColorPicker" onchange="updateCustomColors()" style="width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer;">
                </div>
                <div class="setting-option">
                    <span>لون الخط</span>
                    <input type="color" id="textColorPicker" onchange="updateCustomColors()" style="width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer;">
                </div>
                <button class="logout-button" style="width: 100%; margin-top: 15px; background: #6c757d;" onclick="resetColors()">إعادة ضبط الألوان الافتراضية</button>
            </div>

            <div class="content-box">
                <h4>إدارة البيانات</h4>
                 <div class="setting-option">
                    <span>مسح بيانات المفضلة</span>
                    <button class="logout-button" style="width: 100px; padding: 8px; font-size: 0.9rem; margin-top: 0;" onclick="clearAllData(false); displayFavorites();">مسح</button>
                </div>
                <div class="setting-option">
                    <span>مسح بيانات الدخول والمفضلة</span>
                    <button class="logout-button" style="width: 100px; padding: 8px; font-size: 0.9rem; margin-top: 0;" onclick="clearAllData(true)">مسح الكل</button>
                </div>
            </div>
            
            <div class="content-box">
                <h4>إرسال إشعار تجريبي</h4>
                <div class="input-group" style="margin-bottom: 10px;">
                    <input type="text" id="notif-title-input" placeholder="عنوان الإشعار" style="padding: 10px;">
                </div>
                <div class="input-group" style="margin-bottom: 10px;">
                    <input type="text" id="notif-msg-input" placeholder="نص الرسالة" style="padding: 10px;">
                </div>
                <button class="login-button" style="margin-top: 10px; padding: 12px;" onclick="sendManualNotification()">إرسال الإشعار الآن</button>
            </div>
            
            <p style="text-align: center; margin-top: 20px; font-size: 0.85rem; color: #777;">
                * مسح الكل يتطلب إعادة تسجيل الدخول.
            </p>
        </div>
    </div>
    
    <div id="importantAdds" class="modal">
         <div class="modal-content">
            <span class="close-button" onclick="closeModal('importantAdds')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">🌟</span> إضافات هامة</h2>
            <div class="content-box">
                <h4>إعلانات هامة</h4>
                <p id="admin-announcement">سنوات سابقة، نماذج أسئلة، وملازم إثرائية متوفرة في قسم الإعلانات.</p>
            </div>
             <ul class="stage-list" id="dynamic-links-list">
                <li class="stage-item" onclick="window.open('https://t.me/MansourIndustrial', '_blank')">
                    <span>قناة التليجرام الرسمية</span><span>&larr;</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- لوحة التحكم الإدارية -->
    <div id="adminPanel" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closeModal('adminPanel')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: #dc3545; margin-left: 10px;">🔐</span> لوحة التحكم</h2>
            
            <div id="admin-login-section">
                <div class="input-group">
                    <label>كلمة مرور الإدارة:</label>
                    <input type="password" id="admin-pass-input" placeholder="أدخل كلمة المرور">
                </div>
                <button class="login-button" onclick="checkAdminAccess()">دخول المسؤول</button>
            </div>

            <div id="admin-tools-section" style="display: none;">
                <div class="content-box">
                    <h4>إرسال إشعار عام</h4>
                    <input type="text" id="admin-notif-title" placeholder="عنوان الإشعار" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
                    <textarea id="admin-notif-msg" placeholder="نص الرسالة" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; height:80px;"></textarea>
                    <button class="login-button" style="padding:10px; margin-top:10px;" onclick="adminSendNotification()">بث الإشعار الآن 📢</button>
                </div>

                <div class="content-box">
                    <h4>تحديث الإعلان الرئيسي</h4>
                    <textarea id="admin-announcement-input" placeholder="نص الإعلان الجديد" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; height:60px;"></textarea>
                    <button class="login-button" style="padding:10px; margin-top:10px; background: #28a745;" onclick="adminUpdateAnnouncement()">تحديث الإعلان ✨</button>
                </div>

                <div class="content-box">
                    <h4>إضافة رابط سريع</h4>
                    <input type="text" id="admin-link-title" placeholder="عنوان الرابط (مثلاً: نتائج الدور الأول)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="text" id="admin-link-url" placeholder="رابط URL" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <button class="login-button" style="padding:10px; margin-top:10px; background: #17a2b8;" onclick="adminAddLink()">إضافة الرابط 🔗</button>
                </div>
                
                <button class="logout-button" onclick="localStorage.removeItem('adminSession'); location.reload();">تسجيل خروج المسؤول</button>
            </div>
        </div>
    </div>
    
    <div id="digitalReader" class="modal">
         <div class="modal-content">
            <span class="close-button" onclick="closeModal('digitalReader')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">📖</span> قارئ الدرس الرقمي</h2>
            <div class="content-box">
                <h4>ملاحظة:</h4>
                <p>هذه الميزة ستقوم بفتح ملفات PDF/محتوى الدرس مباشرة في التطبيق. يرجى تصفح المواد والضغط على اسم المادة للبدء في القراءة.</p>
            </div>
            <button class="main-button" style="height: 60px;" onclick="closeModal('digitalReader'); openModal('stagesBrowser')">
                <span class="button-text">ابدأ تصفح المواد</span>
            </button>
        </div>
    </div>
    
    <div id="usageGuide" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('usageGuide')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">💡</span> شرح الإستخدام</h2>
            <div class="content-box">
                <h4>كيف تستخدم التطبيق؟</h4>
                <p>
                    1. قم بملء بيانات تسجيل الدخول. <br>
                    2. استخدم زر "**تصفح الأقسام والمراحل**" للعثور على مادتك. <br>
                    3. **اضغط على اسم المادة** في قائمة المواد لفتحها مباشرة داخل التطبيق (القارئ الرقمي). <br>
                    4. اضغط على رمز **"💖"** لإضافة أي مادة إلى **مفضلتي**. <br>
                    5. استخدم أيقونة **"👤"** للوصول إلى بيانات حسابك. <br>
                    6. استخدم أيقونة **"🌙"** لتبديل وضع العرض.
                    7. استخدم زر **"🤖"** للوصول إلى **المساعد الذكي** لحل الأسئلة.
                    8. استخدم زر **"⚠️"** للدخول إلى سجل **الإنذارات والغيابات** المشترك.
                </p>
            </div>
        </div>
    </div>
    
    <div id="supportShare" class="modal">
         <div class="modal-content">
            <span class="close-button" onclick="closeModal('supportShare')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">📣</span> دعم ونشر التطبيق</h2>
            <div class="content-box">
                <h4>دعم المطورين:</h4>
                <p>
                    التطبيق مجاني بالكامل وتم تطويره لخدمة طلاب الإعدادية. دعمكم لنا يكون عبر نشر التطبيق بين زملائكم.
                </p>
            </div>
            <button class="main-button" style="height: 60px; background: linear-gradient(135deg, #25d366, #128c7e);" onclick="alert('فتح رابط مشاركة واتساب')">
                <span class="button-text">مشاركة عبر واتساب</span>
            </button>
            <button class="main-button" style="height: 60px; background: linear-gradient(135deg, #0077b5, #005580); margin-top: 15px;" onclick="alert('فتح رابط مشاركة فيسبوك')">
                <span class="button-text">مشاركة عبر فيسبوك</span>
            </button>
        </div>
    </div>

    <div id="bookReader" class="modal">
        <div class="modal-content">
            <div class="header-reader">
                <h2 id="reader-book-title">قارئ الدرس الرقمي</h2>
                <button class="close-button" onclick="closeModal('bookReader')">
                    إغلاق القارئ &times;
                </button>
            </div>
            <iframe id="book-iframe" src="" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>

    <!-- نافذة الآلة الحاسبة -->
    <div id="calculator" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('calculator')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">🧮</span> الآلة الحاسبة</h2>
            
            <div class="calculator-container" style="margin-top: 20px;">
                <input type="text" id="calc-display" class="calc-display" readonly style="width: 100%; padding: 15px; font-size: 1.8rem; font-weight: 700; border: 2px solid var(--primary-color); border-radius: 12px; background-color: var(--input-bg); color: var(--text-color); text-align: right; margin-bottom: 15px; letter-spacing: 2px;">
                
                <div class="calc-buttons" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <!-- صف الأزرار الأول: مسح وحذف والعمليات -->
                    <button class="calc-btn" onclick="clearCalc()" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: 700; grid-column: span 2; transition: all 0.2s;">مسح</button>
                    <button class="calc-btn" onclick="deleteLastChar()" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s;">⌫</button>
                    <button class="calc-btn" onclick="appendToCalc('/')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s;">÷</button>
                    
                    <!-- الأرقام والعمليات -->
                    <button class="calc-btn" onclick="appendToCalc('7')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">7</button>
                    <button class="calc-btn" onclick="appendToCalc('8')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">8</button>
                    <button class="calc-btn" onclick="appendToCalc('9')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">9</button>
                    <button class="calc-btn" onclick="appendToCalc('*')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s;">×</button>
                    
                    <button class="calc-btn" onclick="appendToCalc('4')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">4</button>
                    <button class="calc-btn" onclick="appendToCalc('5')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">5</button>
                    <button class="calc-btn" onclick="appendToCalc('6')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">6</button>
                    <button class="calc-btn" onclick="appendToCalc('-')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s;">−</button>
                    
                    <button class="calc-btn" onclick="appendToCalc('1')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">1</button>
                    <button class="calc-btn" onclick="appendToCalc('2')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">2</button>
                    <button class="calc-btn" onclick="appendToCalc('3')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">3</button>
                    <button class="calc-btn" onclick="appendToCalc('+')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s;">+</button>
                    
                    <button class="calc-btn" onclick="appendToCalc('0')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s; grid-column: span 2;">0</button>
                    <button class="calc-btn" onclick="appendToCalc('.')" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-color); cursor: pointer; font-weight: 700; transition: all 0.2s;">.</button>
                    
                    <button class="calc-btn" onclick="calculateResult()" style="padding: 15px; font-size: 1.2rem; border-radius: 10px; background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: 700; grid-column: span 4; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 121, 107, 0.4);">=</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة سجل الملاحظات -->
    <div id="notepad" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('notepad')">&times;</span>
            <h2><span style="font-size: 1.5rem; color: var(--primary-color); margin-left: 10px;">📝</span> سجل الملاحظات</h2>
            
            <div class="notepad-container" style="margin-top: 20px;">
                <div class="input-group">
                    <label for="note-title">عنوان الملاحظة:</label>
                    <input type="text" id="note-title" placeholder="أدخل عنوان الملاحظة..." style="width: 100%; padding: 12px; border: 2px solid var(--input-bg); border-radius: 12px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem;">
                </div>
                
                <div class="input-group" style="margin-top: 15px;">
                    <label for="note-content">محتوى الملاحظة:</label>
                    <textarea id="note-content" placeholder="اكتب ملاحظتك هنا..." style="width: 100%; padding: 12px; border: 2px solid var(--input-bg); border-radius: 12px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; min-height: 150px; resize: vertical;"></textarea>
                </div>
                
                <button class="main-button" style="height: 50px; margin-top: 15px;" onclick="addNote()">
                    <span class="button-text">حفظ الملاحظة</span>
                </button>
            </div>
            
            <div style="margin-top: 30px; border-top: 1px solid var(--input-bg); padding-top: 20px;">
                <h3 style="color: var(--secondary-color); margin-bottom: 15px;">ملاحظاتي:</h3>
                <ul id="notes-list" style="list-style: none; padding: 0;">
                </ul>
                <p id="empty-notes" style="text-align: center; color: #777; font-weight: 700; margin-top: 20px;">
                    لا توجد ملاحظات حتى الآن. أضف ملاحظتك الأولى!
                </p>
            </div>
        </div>
    </div>


    <!-- زر المشاركة العائم -->
    <div id="floating-share" class="share-btn-floating" onclick="shareApp()">
        <span>📤</span>
    </div>

    <script>
        // إعداد Facebook SDK
        window.fbAsyncInit = function() {
            FB.init({
                appId      : 'YOUR_FACEBOOK_APP_ID',
                cookie     : true,
                xfbml      : true,
                version    : 'v18.0'
            });
        };

        // دالة تسجيل الدخول بجوجل
        function handleGoogleLogin(response) {
            console.log("Google Login Success", response);
            alert("تم تسجيل الدخول بنجاح عبر جوجل!");
            completeSocialLogin("مستخدم جوجل");
        }

        // دالة تسجيل الدخول بجوجل
        function loginWithGoogle() {
            const googleName = prompt('أدخل اسمك (سيتم استخدامه من حسابك على جوجل):');
            if (googleName) {
                document.getElementById('studentName').value = googleName;
                alert('✅ تم الاتصال بحسابك على جوجل بنجاح!\nالآن أكمل باختيار القسم والمرحلة.');
                document.getElementById('studentSection').focus();
            }
        }
        
        // دالة تسجيل الدخول بفيسبوك
        function loginWithFacebook() {
            FB.login(function(response) {
                if (response.status === 'connected') {
                    FB.api('/me', {fields: 'name,email'}, function(userData) {
                        alert("أهلاً بك " + userData.name + "، تم الدخول عبر فيسبوك!");
                        completeSocialLogin(userData.name);
                    });
                }
            }, {scope: 'public_profile,email'});
        }

        // دالة إتمام الدخول الاجتماعي
        function completeSocialLogin(userName) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userName', userName);
            
            // إخفاء شاشة الدخول وإظهار التطبيق
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app-container').style.display = 'block';
            document.getElementById('mode-toggle').classList.remove('hidden');
            document.getElementById('profile-button').classList.remove('hidden');
            document.getElementById('floating-share').style.display = 'flex';
            
            // تشغيل الأنيميشن
            document.getElementById('main-app-container').style.animation = 'fadeInUp 0.8s ease forwards';
        }

        // نظام الإشعارات الذكي
        function showNotification(title, message, icon = '🔔', duration = 5000) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notif-title').textContent = title;
            document.getElementById('notif-message').textContent = message;
            document.getElementById('notif-icon').textContent = icon;
            
            toast.classList.add('show');
            
            // تشغيل صوت تنبيه بسيط إذا أردت
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}

            setTimeout(() => {
                hideNotification();
            }, duration);
        }

        function hideNotification() {
            document.getElementById('notification-toast').classList.remove('show');
        }

        // دالة لإرسال إشعار يدوي من الواجهة
        function sendManualNotification() {
            const title = document.getElementById('notif-title-input').value.trim();
            const message = document.getElementById('notif-msg-input').value.trim();
            
            if (title === "" || message === "") {
                alert("الرجاء إدخال العنوان والرسالة أولاً.");
                return;
            }
            
            showNotification(title, message, '📢');
            
            // تصفير الحقول بعد الإرسال
            document.getElementById('notif-title-input').value = "";
            document.getElementById('notif-msg-input').value = "";
        }

        // دالة لاستقبال الإشعارات من "لوحة التحكم" (محاكاة باستخدام LocalStorage)
        function listenForNotifications() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'admin_notification_trigger') {
                    const data = JSON.parse(e.newValue);
                    showNotification(data.title, data.message, data.icon);
                    updateNotifUI();
                }
            });
        }
        
        function openNotificationsModal() {
            openModal('notificationsModal');
            markAllAsRead();
        }

        function updateNotifUI() {
            const list = document.getElementById('notifications-list');
            const badge = document.getElementById('notif-badge');
            const allNotifs = JSON.parse(localStorage.getItem('all_notifications') || '[]');
            
            if (allNotifs.length === 0) {
                list.innerHTML = '<p style="text-align: center; padding: 20px; color: #777;">لا توجد إشعارات حالياً.</p>';
                badge.style.display = 'none';
                return;
            }

            let html = '';
            let unreadCount = 0;
            allNotifs.forEach(n => {
                if (n.unread) unreadCount++;
                html += `
                    <div class="notif-item ${n.unread ? 'unread' : ''}">
                        <div class="notif-title">${n.icon} ${n.title}</div>
                        <div class="notif-message">${n.message}</div>
                        <div class="notif-time">${n.time}</div>
                    </div>
                `;
            });

            list.innerHTML = html;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function markAllAsRead() {
            let allNotifs = JSON.parse(localStorage.getItem('all_notifications') || '[]');
            allNotifs.forEach(n => n.unread = false);
            localStorage.setItem('all_notifications', JSON.stringify(allNotifs));
            updateNotifUI();
        }

        function clearNotifications() {
            if(confirm("هل أنت متأكد من مسح جميع الإشعارات؟")) {
                localStorage.removeItem('all_notifications');
                updateNotifUI();
            }
        }
        
        // تشغيل الاستماع عند التحميل
        listenForNotifications();

        // --- وظائف لوحة التحكم الإدارية ---
        const ADMIN_PASSWORD = "admin123"; // يمكنك تغيير كلمة المرور هنا

        function checkAdminAccess() {
            const pass = document.getElementById('admin-pass-input').value;
            if (pass === ADMIN_PASSWORD) {
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-tools-section').style.display = 'block';
                localStorage.setItem('adminSession', 'active');
            } else {
                alert("كلمة المرور غير صحيحة!");
            }
        }

        function adminSendNotification() {
            const title = document.getElementById('admin-notif-title').value;
            const msg = document.getElementById('admin-notif-msg').value;
            if (!title || !msg) return alert("أكمل البيانات");
            
            const notifData = { 
                id: Date.now(),
                title, 
                message: msg, 
                icon: '📢', 
                time: new Date().toLocaleString('ar-EG'),
                unread: true 
            };

            // حفظ في قائمة الإشعارات العامة
            let allNotifs = JSON.parse(localStorage.getItem('all_notifications') || '[]');
            allNotifs.unshift(notifData);
            localStorage.setItem('all_notifications', JSON.stringify(allNotifs));

            // إرسال إشارة للمتصفحات الأخرى
            localStorage.setItem('admin_notification_trigger', JSON.stringify(notifData));
            
            showNotification(title, msg, '📢');
            updateNotifUI();
            alert("تم بث الإشعار بنجاح لجميع الطلبة!");
            
            // تصفير الحقول
            document.getElementById('admin-notif-title').value = '';
            document.getElementById('admin-notif-msg').value = '';
        }

        function adminUpdateAnnouncement() {
            const text = document.getElementById('admin-announcement-input').value;
            if (!text) return alert("أدخل نص الإعلان");
            localStorage.setItem('admin_announcement_text', text);
            applyAdminData(); updateNotifUI();
            alert("تم تحديث الإعلان!");
        }

        function adminAddLink() {
            const title = document.getElementById('admin-link-title').value;
            const url = document.getElementById('admin-link-url').value;
            if (!title || !url) return alert("أكمل البيانات");
            
            let links = JSON.parse(localStorage.getItem('admin_links') || "[]");
            links.push({ title, url });
            localStorage.setItem('admin_links', JSON.stringify(links));
            applyAdminData(); updateNotifUI();
            alert("تم إضافة الرابط!");
        }

        function applyAdminData() {
            // تطبيق الإعلان
            const savedAnnounce = localStorage.getItem('admin_announcement_text');
            if (savedAnnounce) {
                const el = document.getElementById('admin-announcement');
                if (el) el.textContent = savedAnnounce;
            }

            // تطبيق الروابط
            const savedLinks = JSON.parse(localStorage.getItem('admin_links') || "[]");
            const list = document.getElementById('dynamic-links-list');
            if (list) {
                // نبقي على أول رابط (التليجرام) ونضيف البقية
                const staticLink = `<li class="stage-item" onclick="window.open('https://t.me/MansourIndustrial', '_blank')"><span>قناة التليجرام الرسمية</span><span>&larr;</span></li>`;
                let html = staticLink;
                savedLinks.forEach(link => {
                    html += `<li class="stage-item" onclick="window.open('${link.url}', '_blank')"><span>${link.title}</span><span>&larr;</span></li>`;
                });
                list.innerHTML = html;
            }
        }

        // استدعاء البيانات عند التحميل
        window.addEventListener('load', () => {
            applyAdminData(); updateNotifUI();
            if (localStorage.getItem('adminSession') === 'active') {
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-tools-section').style.display = 'block';
            }
        });

        // دالة مشاركة المحتوى
        async function shareApp() {
            const shareData = {
                title: 'تطبيق إعدادية المنصور الصناعية',
                text: 'تحقق من هذا التطبيق التعليمي الرائع لإعدادية المنصور الصناعية!',
                url: window.location.href
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    const shareUrl = `https://wa.me/?text=${encodeURIComponent(shareData.text + " " + shareData.url)}`;
                    window.open(shareUrl, '_blank');
                }
            } catch (err) {
                console.log('Error sharing:', err);
            }
        }
        
        // ===========================================
        // =          وظائف إدارة التطبيق JS          =
        // ===========================================
        
        const loginScreen = document.getElementById('login-screen');
        const mainAppContainer = document.getElementById('main-app-container');
        const modeToggle = document.getElementById('mode-toggle');
        const modeIcon = document.getElementById('mode-icon'); 
        const profileButton = document.getElementById('profile-button'); 
        const supportFab = document.getElementById('support-fab');
        const mainSearchInput = document.getElementById('main-search-input');
        const browserSearchInput = document.getElementById('browser-search-input');
        
        const sectionsContainer = document.getElementById('sections-container');
        const stagesBySectionContainer = document.getElementById('stages-by-section-container');
        const booksContainer = document.getElementById('books-container');
        const sectionStagesTitle = document.getElementById('section-stages-title');
        const stagesListBySection = document.getElementById('stages-list-by-section');
        const stageTitle = document.getElementById('stage-title');
        const subjectsList = document.getElementById('subjects-list');
        const sectionLink = document.getElementById('section-link');
        const loginErrorMessage = document.getElementById('login-error-message');
        const favoritesList = document.getElementById('favorites-list');
        const emptyFavoritesMessage = document.getElementById('empty-favorites');
        
        // عناصر نافذة الملف الشخصي
        const profileName = document.getElementById('profile-name');
        const profileSection = document.getElementById('profile-section');
        const profileStage = document.getElementById('profile-stage');
        const profileImgDisplay = document.getElementById('profile-img-display');

        // عناصر القارئ الرقمي (الجديدة)
        const bookReaderModal = document.getElementById('bookReader');
        const readerBookTitle = document.getElementById('reader-book-title');
        const bookIframe = document.getElementById('book-iframe');


        // متغير عالمي لحفظ مفتاح القسم الحالي للعودة إليه
        window.currentSectionKey = ''; 
        window.currentStageName = '';
        
        // ===========================================
        // ==  بيانات الكتب والأقسام (تم التحديث هنا) ==
        // ===========================================
        
        const officialLink = "https://t.me/MansourIndustrial";

        function createSubject(name, type, stageName, edition, link = "#") {
            const id = `sub-${name.replace(/\s/g, '_')}-${stageName}`;
            return { id, name, type, stageName, edition, link };
        }

        // الرابط الخاص بكتاب العربي للمرحلة الأولى (تم الإبقاء عليه كما هو)
        const arabicBookLink = "https://drive.google.com/file/d/1K4Sh-k50MdJonN8eBERWsJQ2dY3qvbqM/preview";


        const stageNames = {
            '1': "الأول المهني",
            '2': "الثاني المهني",
            '3': "الثالث المهني",
        };

        // تحديث مواد العامة المشتركة بالروابط الجديدة التي قدمها المستخدم
        const generalSubjects = {
            '1': [
                // المواد العامة للمرحلة الأولى - تم الإبقاء على القديم، لا يوجد جديد
                createSubject("الطبيعيات", "كتاب أساسي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/13gNIdTfUpQS9sPtA4mKZcuIMieOo242j/preview"),
                createSubject("اللغة العربية", "كتاب أساسي", "الأول", "إصدار 2024", arabicBookLink), 
                createSubject("الرياضيات", "كتاب أساسي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1UV0JumL_Ect_cdkOdjcKzyLr-mB-X6vU/preview"),
                createSubject("اللغة الإنكليزية", "كتاب أساسي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1K5erclI6vetKB8Img-kZsmEaa0yfPFsD/preview"),
                createSubject("التربية الإسلامية", "كتاب أساسي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1e4GRZhD9JMBEA_g8OS-Qqy6iXDT-F54D/preview")
            ],
            // تحديث المرحلة الثانية بالروابط الجديدة المطلوبة
            '2': [
                // تحديث الطبيعيات
                createSubject("الطبيعيات", "كتاب أساسي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1pEdZM4e3sg2StYLM9Ijt07m937f7wMOc/preview"),
                // تحديث اللغة العربية
                createSubject("اللغة العربية", "كتاب أساسي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1mQj5m_u-J2L69I2Y8eqNCNqROes_s48e/preview"),
                createSubject("الرياضيات", "كتاب أساسي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1N9-2fp5azs1baCgy2wZKEojE60teeGac/preview"),
                // تحديث اللغة الإنكليزية
                createSubject("اللغة الإنكليزية", "كتاب أساسي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/17-fpF6uAwMBRaCcAY21GyK4lp53Dyfoy/preview"),
                createSubject("التربية الإسلامية", "كتاب أساسي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1rF1gy-iXkgnUMzrN7CntKtQav-HvSM7f/preview")
            ],
            // تحديث مواد المرحلة الثالثة (الثالث المهني) بالروابط المطلوبة
            '3': [
                createSubject("الطبيعيات", "كتاب أساسي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1l5MkyOqx98j4NJ8_nSorooVx-MTkgbA1/preview"),
                // تحديث اللغة العربية
                createSubject("اللغة العربية", "كتاب أساسي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1D-s2ddrAOVVAnWtcst473tyqXbyGJV78/preview"),
                createSubject("الرياضيات", "كتاب أساسي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1VmFNZOIpJytzxGhssMwRSXJvJseLNhc_/preview"),
                // تحديث اللغة الإنكليزية
                createSubject("اللغة الإنكليزية", "كتاب أساسي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1XRYfzOFh1R0eLFfbK0Mk7OreVd6uqEm3/preview"),
                // تحديث التربية الإسلامية
                createSubject("التربية الإسلامية", "كتاب أساسي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1NtgFUMU4Hb4f86wiNDPlVFWHWnpFIu-t/preview")
            ]
        };

        const vocationalSections = {
            elec: { name: "قسم الكهرباء", link: officialLink, stages: {
                'elec_1': { name: stageNames['1'], books: [
                    ...generalSubjects['1'],
                    // العلوم الصناعية الكهربائية - المرحلة الأولى
                    createSubject("العلوم الصناعية الكهربائية", "كتاب تخصصي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1jZ3fU7z7aUFxKIa4hFoBsWpN_k19AZUe/preview"),
                    createSubject("الرسم الهندسي الكهربائي", "كتاب تطبيقي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/11zGADipLPCOeeV4pYd-ZaJ-zFUoderbR/preview"),
                    // التدريب العملي الكهربائي - المرحلة الأولى (الرابط المطلوب)
                    createSubject("التدريب العملي الكهربائي", "كتاب عملي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1-FDXsHQNYPbQ6gSFdTvU70S13NawA0iE/preview"), 
                ] },
                'elec_2': { name: stageNames['2'], books: [
                    ...generalSubjects['2'],
                    // العلوم الصناعية الكهربائية - المرحلة الثانية
                    createSubject("العلوم الصناعية الكهربائية", "كتاب تخصصي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1V3O2fG3Ay0wpRzHu_uTY5EakgsqQI-GA/preview"),
                    createSubject("الرسم الهندسي الكهربائي", "كتاب تطبيقي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1lOrRKkOopZb32Bmw4ILWJe9rFYWEiGb4/preview"),
                    // التدريب العملي الكهربائي - المرحلة الثانية
                    createSubject("التدريب العملي الكهربائي", "كتاب عملي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1UO-jcnm7BhIW7–NkdAcmt2YQkO-JBZ-/view?usp=drivesdk"),
                ] },
                'elec_3': { name: stageNames['3'], books: [
                    ...generalSubjects['3'],
                    // العلوم الصناعية الكهربائية - المرحلة الثالثة
                    createSubject("العلوم الصناعية الكهربائية", "كتاب تخصصي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1nDagm7HFt1lj4vsOsk6_dSYgwBxVGdIG/preview"),
                    createSubject("الرسم الهندسي الكهربائي", "كتاب تطبيقي", "الثالث", "إصدار 2024"),
                    // التدريب العملي الكهربائي - المرحلة الثالثة
                    createSubject("التدريب العملي الكهربائي", "كتاب عملي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1yC8O086OBo66IHPrVQfB0HCHFR41fmYF/preview"),
                ] }
            }},
            elecs: { name: "قسم الإلكترونيك والسيطرة", link: officialLink, stages: {
                // تحديث كتب الإلكترونيك والسيطرة بالكتب الجديدة المقدمة
                'elecs_1': { name: stageNames['1'], books: [
                    ...generalSubjects['1'],
                    // أول إلكترون علوم
                    createSubject("العلوم الصناعية الإلكترونية", "كتاب تخصصي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1wvetwbh_wwu5Asfgtfb7K7GpGZXtm5vA/preview"),
                    // الرسم الصناعي الإلكتروني - تم إزالة رابط التدريب العملي منه
                    createSubject("الرسم الصناعي الإلكتروني", "كتاب تطبيقي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/16pQ4w6-BnqhOTb0igth7YEO8jwbI-lmi/preview"), 
                    // التدريب العملي الإلكتروني - تم إضافة رابط التدريب العملي (مرحلة أولى) المطلوب
                    createSubject("التدريب العملي الإلكتروني", "كتاب عملي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1WFWj2QR5dZLXQs5pkVv6e1t7Wf_h0rdq/preview"), 
                ] },
                'elecs_2': { name: stageNames['2'], books: [
                    ...generalSubjects['2'],
                    // العلوم الصناعيه الكترونيك الثاني
                    createSubject("العلوم الصناعية الإلكترونية", "كتاب تخصصي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1MyvqU9lKs3ZfK_aeak4L-mdNUHOqwTn5/preview"),
                    // الرسم الصناعي الكترونيك وسيطرة الثاني
                    createSubject("الرسم الصناعي الإلكتروني", "كتاب تطبيقي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1Zl094Z0apla7_ZQPQ01DHs-PUfKccy9G/preview"),
                    // التدريب العملي الإلكتروني - تم إضافة رابط التدريب العملي (مرحلة ثانية) المطلوب
                    createSubject("التدريب العملي الإلكتروني", "كتاب عملي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1MB0u1mEz5tgjhRV-gAGZv5dwHRTwF8SR/preview"), 
                ] },
                'elecs_3': { name: stageNames['3'], books: [
                    ...generalSubjects['3'],
                    // العلوم الصناعي الكترونيك والسيطرة الثالثه
                    createSubject("العلوم الصناعية الإلكترونية", "كتاب تخصصي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1XssU-nGxtHEi3oHUqLFtHCRDLgNmgXjH/preview"),
                    // الرسم الصناعي الكترونيك والسيطرة الثالث
                    createSubject("الرسم الصناعي الإلكتروني", "كتاب تطبيقي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1hWdVITONaKf8p7D5wZqkYLJjfqIEql4X/preview"),
                    // التدريب العملي إلكترون وسيطره الثالث مهني
                    createSubject("التدريب العملي الإلكتروني", "كتاب عملي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1l-b_ok2-Ogfxk7-mR6Bol99jlVqxplHd/preview"),
                ] }
            }},
            media: { name: "قسم تكنولوجيا الإعلام", link: officialLink, stages: {
                // تحديث كتب تكنولوجيا الإعلام بالكتب الجديدة المقدمة
                'media_1': { name: stageNames['1'], books: [
                    ...generalSubjects['1'],
                    // العلوم تكنلوجيا إعلام الاولى
                    createSubject("العلوم الصناعية لتكنولوجيا الإعلام", "كتاب تخصصي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1OK95pQuOg3z40WyGFONyy-oYhHkRiUDD/preview"),
                    // الرسم مرحلة أولى تكنلوجيا إعلام (تم التحديث)
                    createSubject("الرسم الصناعي لتكنولوجيا الإعلام", "كتاب تطبيقي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1imUBO6mxJcQcUhEKEpgs_CQ-Hr1uH3Xu/preview"), 
                    // العملي تكنلوجيا إعلام الاول
                    createSubject("التدريب العملي لتكنولوجيا الإعلام", "كتاب عملي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1HgOdWicSSPoL8YWCj2cqMETpnpW1MVP9/preview"),
                ] },
                'media_2': { name: stageNames['2'], books: [
                    ...generalSubjects['2'],
                    // العلوم الصناعية تكنلوجيا إعلام الثاني
                    createSubject("العلوم الصناعية لتكنولوجيا الإعلام", "كتاب تخصصي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1QaOaG39SWdRmPP_uD0S5VkgV4unYRCZ1/preview"),
                    // الرسم الصناعي تكنلوجيا إعلام الثاني
                    createSubject("الرسم الصناعي لتكنولوجيا الإعلام", "كتاب تطبيقي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1xXyijQ89qYjo93J2a3eMy8TmzpBgprhe/preview"),
                    // التدريب العملي تكنلوجيا إعلام الثاني مهني
                    createSubject("التدريب العملي لتكنولوجيا الإعلام", "كتاب عملي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1FL0sjrjsCQYRraahDiFNoMVsHb0epKVD/preview"),
                ] },
                'media_3': { name: stageNames['3'], books: [
                    ...generalSubjects['3'],
                    // العلوم الثالث تكنلوجيا إعلام
                    createSubject("العلوم الصناعية لتكنولوجيا الإعلام", "كتاب تخصصي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/15-0kmdpnlbGG228fRBJspH46tThwK56G/preview"),
                    // الرسم الصناعي تكنلوجيا إعلام الصف الثالث مهني
                    createSubject("الرسم الصناعي لتكنولوجيا الإعلام", "كتاب تطبيقي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1zzbzuDKaJbED-1SAkw41wlN2fZb2UmF8/preview"),
                    // التدريب العملي مرحلة الثالث مهني تكنلوجيا إعلام
                    createSubject("التدريب العملي لتكنولوجيا الإعلام", "كتاب عملي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1Oz1NJoe2rmr55RtvEyh1Po3wqq0MHUFp/preview"),
                ] }
            }},
            med: { name: "قسم الأجهزة الطبية", link: officialLink, stages: {
                // تحديث كتب الأجهزة الطبية بالكتب الجديدة المقدمة
                'med_1': { name: stageNames['1'], books: [
                    ...generalSubjects['1'],
                    // العلوم الصناعيه الاول اجهزه طبيع
                    createSubject("العلوم الصناعية للأجهزة الطبية", "كتاب تخصصي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1d8-I6mzRpCaoUPduexb5qNIVUWQ5aFg6/preview"),
                    // التدريب العملي الصناعي اجهزه طبيه الاول
                    createSubject("التدريب العملي للأجهزة الطبية", "كتاب عملي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1ezjvnuyaqtiA0KE8FSx_iPoWrxuBuDTC/preview"),
                    createSubject("الرسم الصناعي للأجهزة الطبية", "كتاب تطبيقي", "الأول", "إصدار 2024", "https://drive.google.com/file/d/1yCwrRiFadxH8aoy0gPrOKiTlhZtVBiTq/preview"), 
                ] },
                'med_2': { name: stageNames['2'], books: [
                    ...generalSubjects['2'],
                    // علوم أجهزه طبيه الثاني
                    createSubject("العلوم الصناعية للأجهزة الطبية", "كتاب تخصصي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1hBiVoeMEX1bXyN_9qnPAzwtLxZcaP1TY/preview"),
                    // الرسم الصناعي اجهزه طبية الصف الثاني
                    createSubject("الرسم الصناعي للأجهزة الطبية", "كتاب تطبيقي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1KeJDy3y4swTwszo640Ts0Xjllga6i_U2/preview"),
                    // التدريب العملي الاجهزه الطبية للصف الثاني
                    createSubject("التدريب العملي للأجهزة الطبية", "كتاب عملي", "الثاني", "إصدار 2024", "https://drive.google.com/file/d/1gU8tFy0gUxe_Sngx1U51hBlF01QO_ExY/preview"),
                ] },
                'med_3': { name: stageNames['3'], books: [
                    ...generalSubjects['3'],
                    // العلوم الاجهزه طبية الصف الثالث مهني 
                    createSubject("العلوم الصناعية للأجهزة الطبية", "كتاب تخصصي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1RFvJKEfKmmDrUimYpd60iVfb05g-hQcQ/preview"),
                    // رسم مرحلة ثالثه اجهزه طبية (تم التحديث)
                    createSubject("الرسم الصناعي للأجهزة الطبية", "كتاب تطبيقي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1qXF-gEcc1bFPxMQsN8k4eARjNvhqBZNv/preview"), 
                    // العملي اجهزه طبية مرحلة ثالثة (تم التحديث)
                    createSubject("التدريب العملي للأجهزة الطبية", "كتاب عملي", "الثالث", "إصدار 2024", "https://drive.google.com/file/d/1elVyGMVsHGdTdHFzGhJfS6W2v0Ki2Idy/preview"), 
                ] }
            }},
            general: { name: "المواد العامة المشتركة", link: officialLink, stages: {
                'general_1': { name: stageNames['1'], books: generalSubjects['1'] },
                'general_2': { name: stageNames['2'], books: generalSubjects['2'] },
                'general_3': { name: stageNames['3'], books: generalSubjects['3'] }
            }}
        };
        
        // ===========================================
        // == وظائف التطبيق الأساسية (لم يتم التغيير) ==
        // ===========================================
        
        /**
         * دالة لمزامنة حقل البحث الرئيسي مع حقل بحث المتصفح.
         */
        function syncSearchInput() {
            browserSearchInput.value = mainSearchInput.value;
            // إذا كان المستخدم في شاشة التصفح، يتم تصفية المحتوى مباشرة
            if (document.getElementById('stagesBrowser').style.display === 'flex') {
                filterBrowserContent();
            }
        }
        
        async function attemptLogin() {
            const name = document.getElementById('studentName').value.trim();
            const sectionKey = document.getElementById('studentSection').value;
            const stageNumber = document.getElementById('studentStage').value;
            
            // التحقق من الحقول الأساسية
            if (name === "" || sectionKey === "" || stageNumber === "") {
                loginErrorMessage.textContent = "الرجاء إدخال الاسم واختيار القسم والمرحلة.";
                loginErrorMessage.style.display = 'block';
                return;
            }

            // التحقق من أن الاسم حقيقي (ثلاثي على الأقل وباللغة العربية)
            const arabicNamePattern = /^[\u0621-\u064A\s]+$/;
            const nameParts = name.split(/\s+/).filter(part => part.length > 0);
            
            if (!arabicNamePattern.test(name)) {
                loginErrorMessage.textContent = "الرجاء إدخال الاسم باللغة العربية فقط.";
                loginErrorMessage.style.display = 'block';
                return;
            }
            
            if (nameParts.length < 3) {
                loginErrorMessage.textContent = "الرجاء إدخال الاسم الثلاثي الكامل (مثال: محمد علي حسن).";
                loginErrorMessage.style.display = 'block';
                return;
            }
            
            if (nameParts.some(part => part.length < 2)) {
                loginErrorMessage.textContent = "الرجاء التأكد من كتابة الأسماء بشكل صحيح.";
                loginErrorMessage.style.display = 'block';
                return;
            }
            
            // تخزين البيانات في LocalStorage (يقبل أي اسم الآن)
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('studentName', name);
            localStorage.setItem('studentSectionKey', sectionKey);
            localStorage.setItem('studentStageNumber', stageNumber);
            
            // إخفاء شاشة الدخول وإظهار التطبيق
            loginScreen.style.display = 'none';
            mainAppContainer.style.display = 'block';
            
            // إظهار الأزرار الجانبية
            if (modeToggle) { modeToggle.classList.remove('hidden'); modeToggle.style.display = 'flex'; }
            if (profileButton) { profileButton.classList.remove('hidden'); profileButton.style.display = 'flex'; }
            if (supportFab) { supportFab.classList.remove('hidden'); supportFab.style.display = 'flex'; }
            const notifFab = document.getElementById('notif-fab');
            if (notifFab) { notifFab.classList.remove('hidden'); notifFab.style.display = 'flex'; }
            if (document.getElementById('floating-share')) document.getElementById('floating-share').style.display = 'flex';
            
            const bottomNav = document.getElementById('bottom-nav');
            if (bottomNav) bottomNav.style.display = 'flex';

            // تحديث بيانات الملف الشخصي
            updateProfileModal();
            
            alert(`تم تسجيل دخولك بنجاح يا ${name}!`);
        }

        let html5QrCode;
        function toggleScanner() {
            const readerDiv = document.getElementById('reader');
            if (readerDiv.style.display === 'none' || readerDiv.style.display === '') {
                readerDiv.style.display = 'block';
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => handleDecodedText(decodedText),
                    (errorMessage) => {}
                ).catch(err => {
                    console.error("Unable to start scanner", err);
                    alert("تعذر تشغيل الكاميرا. يرجى التأكد من إعطاء الصلاحيات.");
                });
            } else {
                stopScanner();
            }
        }

        function scanFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                html5QrCode.scanFile(file, true)
                    .then(decodedText => handleDecodedText(decodedText))
                    .catch(err => {
                        console.error("Error scanning file", err);
                        alert("لم يتم العثور على كود QR صالح في الصورة. تأكد من وضوح الكود.");
                    });
            }
        }

        function handleDecodedText(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                if (data.name && data.section && data.stage) {
                    document.getElementById('studentName').value = data.name;
                    document.getElementById('studentSection').value = data.section;
                    document.getElementById('studentStage').value = data.stage;
                    stopScanner();
                    alert("تم التعرف على الهوية بنجاح! جاري تسجيل الدخول...");
                    attemptLogin();
                } else {
                    alert("بيانات الهوية غير مكتملة.");
                }
            } catch (e) {
                alert("تنسيق الهوية غير مدعوم.");
            }
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                });
            } else {
                document.getElementById('reader').style.display = 'none';
            }
        }

        async function downloadIDCard() {
            const front = document.querySelector('.student-card-front');
            const back = document.querySelector('.student-card-back');
            if (!front || !back) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "⏳ جاري التحميل...";
            btn.disabled = true;

            try {
                // تأكد من أن الوجهين مرئيين لـ html2canvas
                const wrapper = document.querySelector('.student-card-inner');
                const originalTransform = wrapper.style.transform;
                wrapper.style.transform = 'none';
                
                const canvasFront = await html2canvas(front, { scale: 2, useCORS: true, backgroundColor: null });
                
                // قلب البطاقة برمجياً لالتقاط الظهر
                wrapper.style.transform = 'rotateY(180deg)';
                const canvasBack = await html2canvas(back, { scale: 2, useCORS: true, backgroundColor: null });
                
                // إعادة الحالة الأصلية
                wrapper.style.transform = originalTransform;
                
                // دمج الوجهين في صورة واحدة
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = canvasFront.width;
                finalCanvas.height = canvasFront.height + canvasBack.height + 40;
                const ctx = finalCanvas.getContext('2d');
                
                // خلفية بيضاء للصورة النهائية
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                ctx.drawImage(canvasFront, 0, 0);
                ctx.drawImage(canvasBack, 0, canvasFront.height + 40);

                const link = document.createElement('a');
                link.download = `Student_ID_${localStorage.getItem('studentName') || 'Card'}.png`;
                link.href = finalCanvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("Download failed", err);
                alert("فشل تحميل الهوية. يرجى المحاولة مرة أخرى.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        let stream;
        function startCamera() {
            const container = document.getElementById('camera-container');
            const video = document.getElementById('video');
            container.style.display = 'block';
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                })
                .catch(err => {
                    alert("تعذر الوصول للكاميرا: " + err);
                    container.style.display = 'none';
                });
        }

        function takeSnapshot() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const display = document.getElementById('profile-img-display');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/png');
            display.src = dataUrl;
            localStorage.setItem('profileImage', dataUrl);
            
            // إيقاف الكاميرا
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('camera-container').style.display = 'none';
            updateProfileModal(); // لتحديث البطاقة بالصورة الجديدة
        }

        function updateProfileModal() {
            const name = localStorage.getItem('studentName') || "غير مسجل";
            const sectionKey = localStorage.getItem('studentSectionKey');
            const stageNumber = localStorage.getItem('studentStageNumber');
            const savedImg = localStorage.getItem('profileImage');
            
            const sectionName = sectionKey ? (vocationalSections[sectionKey] ? vocationalSections[sectionKey].name : sectionKey) : "غير محدد";
            const stageName = stageNumber ? (stageNames[stageNumber] || stageNumber) : "غير محدد";

            profileName.textContent = name;
            profileSection.textContent = sectionName;
            profileStage.textContent = stageName;
            
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6366f1&color=fff&size=128&bold=true`;
            if (savedImg) {
                profileImgDisplay.src = savedImg;
            } else {
                profileImgDisplay.src = avatarUrl;
            }
            
            // توليد بطاقة الطالب
            const cardContainer = document.getElementById('student-card-container');
            const studentId = "MAN-" + Math.random().toString(36).substr(2, 9).toUpperCase();
            const qrData = JSON.stringify({name, section: sectionKey, stage: stageNumber});
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
            cardContainer.innerHTML = `
                <div class="card-wrapper">
                    <div class="student-card-inner">
                        <div class="student-card-front">
                            <div class="card-header">
                                <div class="card-logo">إعدادية المنصور</div>
                                <div class="card-chip"></div>
                            </div>
                            <div class="card-body">
                                <img src="${savedImg || avatarUrl}" class="card-photo">
                                <div class="card-info">
                                    <h3>${name}</h3>
                                    <p>القسم: ${sectionName}</p>
                                    <p>المرحلة: ${stageName}</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="card-id">${studentId}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">(المس للقلب)</div>
                            </div>
                        </div>
                        <div class="student-card-back">
                            <h3 style="margin-bottom: 10px;">الهوية الرقمية</h3>
                            <img src="${qrUrl}" style="width: 100px; height: 100px; background: white; padding: 5px; border-radius: 10px;">
                            <p style="margin-top: 10px; font-size: 0.8rem;">${studentId}</p>
                            <p style="font-size: 0.7rem; margin-top: 5px;">يرجى إبراز هذا الرمز عند الطلب</p>
                        </div>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: #777; text-align: center; margin-top: 10px;">
                    يمكنك استخدام هذه الهوية لتسجيل الدخول السريع في المرة القادمة.
                </p>`;
            
            profileImgDisplay.style.animation = "pulse-avatar 2s infinite";
        }

        function handleProfileImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    localStorage.setItem('profileImage', base64Image);
                    profileImgDisplay.src = base64Image;
                    alert("تم تحديث صورة الملف الشخصي بنجاح! ✨");
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function logout() {
            if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
                clearAllData(false);
                closeModal('userProfile');
                mainAppContainer.style.display = 'none';
                
                // إخفاء الأزرار الجانبية عند تسجيل الخروج
                if (modeToggle) { modeToggle.classList.add('hidden'); modeToggle.style.display = 'none'; }
                if (profileButton) { profileButton.classList.add('hidden'); profileButton.style.display = 'none'; }
                if (supportFab) { supportFab.classList.add('hidden'); supportFab.style.display = 'none'; }
                const notifFab = document.getElementById('notif-fab');
                if (notifFab) { notifFab.classList.add('hidden'); notifFab.style.display = 'none'; }
                if (document.getElementById('floating-share')) document.getElementById('floating-share').style.display = 'none';
                
                const bottomNav = document.getElementById('bottom-nav');
                if (bottomNav) bottomNav.style.display = 'none';

                loginScreen.style.display = 'block';
                
                document.getElementById('studentName').value = '';
                document.getElementById('studentSection').value = '';
                document.getElementById('studentStage').value = '';
                if (document.getElementById('studentEmail')) document.getElementById('studentEmail').value = '';
                if (document.getElementById('studentPassword')) document.getElementById('studentPassword').value = '';
                
                loginErrorMessage.style.display = 'none';
                alert("تم تسجيل الخروج بنجاح.");
            }
        }
        
        function clearAllData(includeTheme = true) {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('studentName');
            localStorage.removeItem('studentSectionKey');
            localStorage.removeItem('studentStageNumber');
            localStorage.removeItem('profileImage');
            localStorage.removeItem('favorites');
            if (includeTheme) {
                 localStorage.removeItem('theme');
            }
            alert("تم مسح جميع بيانات التطبيق (الدخول، المفضلة، الإعدادات). يرجى إعادة الدخول.");
            if (includeTheme) {
                window.location.reload(); 
            }
        }
        
        /**
         * تفتح نافذة منبثقة وتخفي الأزرار الجانبية.
         */
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "flex";
            document.body.style.overflow = "hidden"; 
            
            // إخفاء الأزرار الجانبية
            modeToggle.classList.add('hidden');
            profileButton.classList.add('hidden');
            supportFab.classList.add('hidden'); 
            
            if (modalId === 'stagesBrowser') { 
                // *** تعديل: إضافة استدعاء لـ syncSearchInput و filterBrowserContent ***
                syncSearchInput(); 
                showSections(); 
                filterBrowserContent();
            } else if (modalId === 'userProfile') { 
                updateProfileModal(); 
            } else if (modalId === 'myFavorites') {
                displayFavorites();
            } else if (modalId === 'warningsPunishments') {
                // دالة محاكاة لتحديث قائمة الإنذارات عند الفتح
                // يمكنك تجاهل هذا إذا لم تكن بحاجة لقائمة إنذارات تفاعلية
                updateSimulatedWarnings();
            }
        }
        
        /**
         * تغلق نافذة منبثقة وتظهر الأزرار الجانبية.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
            document.body.style.overflow = "auto";
            
            // إظهار الأزرار الجانبية فقط إذا كان المستخدم مسجلاً دخوله
            if (localStorage.getItem('isLoggedIn') === 'true') {
                modeToggle.classList.remove('hidden');
                profileButton.classList.remove('hidden');
                supportFab.classList.remove('hidden'); 
            }
        }
        
        // ... (بقية دوال المساعدات لم تتغير) ...
        
        function populateSections() {
            const list = document.querySelector('#sections-container .stage-list');
            list.innerHTML = '';
            for (const key in vocationalSections) {
                const section = vocationalSections[key];
                const listItem = document.createElement('li');
                listItem.classList.add('stage-item');
                listItem.dataset.search = section.name; // إضافة خاصية البحث
                
                listItem.onclick = () => showStagesBySection(key);
                
                listItem.innerHTML = `
                    <span>${section.name}</span>
                    <span>&larr;</span>
                `;
                list.appendChild(listItem);
            }
        }
        
        function filterBrowserContent() {
            const searchTerm = browserSearchInput.value.toLowerCase().trim();
            
            const currentContainer = document.querySelector('.modal-content > div:not([style*="display: none"])');
            const listItems = currentContainer ? currentContainer.querySelectorAll('.stage-item, .subject-item') : [];

            listItems.forEach(item => {
                const itemText = item.textContent.toLowerCase();
                // التأكد من أن عنصر قائمة المفضلات لا يتم إخفاؤه
                const isFavoriteListItem = item.closest('#favorites-list');

                // إضافة شرط للبحث في حقل البحث إذا لم يكن في قائمة المفضلة
                if (!isFavoriteListItem) {
                    const isMatch = itemText.includes(searchTerm);
                    item.style.display = isMatch ? 'flex' : 'none';
                }
            });
            // تحديث رسالة قائمة المفضلة في حال كانت القائمة فارغة بعد الفلترة
            if (document.getElementById('myFavorites').style.display === 'flex') {
                const visibleFavorites = Array.from(favoritesList.querySelectorAll('.favorite-list-item')).some(item => item.style.display !== 'none');
                emptyFavoritesMessage.style.display = visibleFavorites ? 'none' : 'block';
            }
        }
        
        browserSearchInput.addEventListener('input', filterBrowserContent);
        
        function getFavorites() {
            const favorites = localStorage.getItem('favorites');
            return favorites ? JSON.parse(favorites) : [];
        }

        function saveFavorites(favorites) {
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function isFavorite(subjectId) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.id === subjectId);
        }

        function toggleFavorite(subject) {
            let favorites = getFavorites();
            const index = favorites.findIndex(fav => fav.id === subject.id);
            const favButton = document.querySelector(`.favorite-toggle[onclick*="'${subject.id}'"]`);

            if (index !== -1) {
                // حذف من المفضلة
                favorites.splice(index, 1);
                alert(`تم حذف "${subject.name}" من المفضلة.`);
                if(favButton) { favButton.classList.remove('is-favorite'); favButton.innerHTML = '🤍'; }
            } else {
                // إضافة إلى المفضلة
                favorites.push(subject);
                alert(`تمت إضافة "${subject.name}" إلى المفضلة.`);
                if(favButton) { favButton.classList.add('is-favorite'); favButton.innerHTML = '💖'; }
            }
            saveFavorites(favorites);
            if (document.getElementById('myFavorites').style.display === 'flex') {
                displayFavorites();
            }
        }
        
        function removeFavorite(subjectId) {
             let favorites = getFavorites();
            const index = favorites.findIndex(fav => fav.id === subjectId);
            if (index !== -1) {
                 const name = favorites[index].name;
                 favorites.splice(index, 1);
                 saveFavorites(favorites);
                 const favButton = document.querySelector(`.favorite-toggle[onclick*="'${subjectId}'"]`);
                 if(favButton) {
                     favButton.classList.remove('is-favorite');
                     favButton.innerHTML = '🤍';
                 }
                 alert(`تم حذف "${name}" من المفضلة.`);
                 displayFavorites();
            }
        }

        function displayFavorites() {
            const favorites = getFavorites();
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                emptyFavoritesMessage.style.display = 'block';
            } else {
                emptyFavoritesMessage.style.display = 'none';
                favorites.forEach(fav => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('favorite-list-item');
                    listItem.innerHTML = `
                        <div>
                            ${fav.name}
                            <span class="subject-details">${vocationalSections[fav.sectionKey].name} - ${fav.stageName}</span>
                        </div>
                        <button class="remove-favorite" onclick="event.stopPropagation(); removeFavorite('${fav.id}')">
                            حذف
                        </button>
                    `;
                    // التعديل: ربط عنصر المفضلة بدالة فتح القارئ
                    // نحتاج للبحث عن الكائن الكامل للمادة لضمان وجود الرابط
                    let book = null;
                    for (const stageKey in vocationalSections[fav.sectionKey].stages) {
                         const stage = vocationalSections[fav.sectionKey].stages[stageKey];
                         book = stage.books.find(b => b.id === fav.id);
                         if (book) break;
                    }
                    
                    if (book && book.link && book.link !== '#') {
                        listItem.onclick = () => openBookInReader(book);
                    }
                    // ----------------------------------------------
                    favoritesList.appendChild(listItem);
                });
            }
            filterBrowserContent(); // لإظهار أو إخفاء العناصر وفقاً للبحث الحالي عند فتح المفضلة
        }
        
        function showSections() {
            sectionsContainer.style.display = 'block';
            stagesBySectionContainer.style.display = 'none';
            booksContainer.style.display = 'none';
            populateSections();
            filterBrowserContent();
        }

        function showStagesBySection(sectionKey) {
            sectionsContainer.style.display = 'none';
            booksContainer.style.display = 'none';
            stagesBySectionContainer.style.display = 'block';
            
            window.currentSectionKey = sectionKey; 
            const section = vocationalSections[sectionKey];
            
            sectionStagesTitle.textContent = `اختيار المرحلة لـ: ${section.name}`;
            stagesListBySection.innerHTML = ''; 
            
            for (const stageKey in section.stages) {
                const stage = section.stages[stageKey];
                const listItem = document.createElement('li');
                listItem.classList.add('stage-item');
                listItem.dataset.search = `${stage.name} ${section.name}`; 
                
                const stageNum = stageKey.split('_')[1]; 
                
                listItem.onclick = () => showBooks(sectionKey, stageNum, stage.name);
                
                listItem.innerHTML = `
                    <span>${stage.name}</span>
                    <span>&larr;</span>
                `;
                stagesListBySection.appendChild(listItem);
            }
            filterBrowserContent();
        }
        
        function showBooks(sectionKey, stageNumber, stageName) {
            stagesBySectionContainer.style.display = 'none';
            booksContainer.style.display = 'block';
            
            const section = vocationalSections[sectionKey];
            const stageKey = `${sectionKey}_${stageNumber}`;
            const stage = section.stages[stageKey];
            
            window.currentStageName = stageName; 
            
            stageTitle.textContent = `${section.name} - ${stageName}`;
            subjectsList.innerHTML = ''; 
            
            document.querySelector('#books-container .back-button').onclick = () => showStagesBySection(window.currentSectionKey);
            
            if (section.link && section.link !== '#') {
                sectionLink.href = section.link;
                sectionLink.style.display = 'inline-block';
            } else {
                sectionLink.style.display = 'none';
            }

            const books = stage.books || [];

            if (books.length === 0) {
                subjectsList.innerHTML = '<p style="color: #dc3545; margin-top: 20px; font-weight: 700;">لا توجد كتب متوفرة لهذا القسم والمرحلة حالياً.</p>';
                return;
            }

            books.forEach(book => {
                const subject = {
                    id: book.id,
                    name: book.name,
                    type: book.type,
                    stageName: stageName,
                    sectionKey: sectionKey,
                    edition: book.edition,
                    link: book.link // إضافة الرابط في كائن المادة
                };

                const isFav = isFavorite(subject.id);
                const subjectJson = JSON.stringify(subject).replace(/"/g, '&quot;');

                const listItem = document.createElement('li');
                listItem.classList.add('subject-item');
                listItem.dataset.search = `${book.name} ${book.type} ${book.edition}`; 
                
                listItem.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <button class="favorite-toggle ${isFav ? 'is-favorite' : ''}" 
                                onclick="event.stopPropagation(); toggleFavorite(${subjectJson})">
                            ${isFav ? '💖' : '🤍'}
                        </button>
                        <div>
                            ${book.name}
                            <span class="subject-details">${book.type} | ${book.edition}</span>
                        </div>
                    </div>
                    <span>&larr;</span>
                `;
                
                // التعديل الرئيسي: ربط النقر بفتح القارئ الرقمي (إذا كان الرابط موجوداً)
                if (book.link && book.link !== '#') {
                    listItem.onclick = () => openBookInReader(book);
                } else {
                    listItem.onclick = () => alert(`المادة "${book.name}" غير متوفرة برابط مباشر حالياً.`);
                }
                
                subjectsList.appendChild(listItem);
            });
            filterBrowserContent();
        }


        /**
         * دالة لفتح ملف Google Drive PDF داخل قارئ التطبيق (iframe).
         * @param {Object} book - كائن يحتوي على بيانات الكتاب ورابطه.
         */
        function openBookInReader(book) {
            if (!book.link || book.link === '#') {
                alert(`المادة "${book.name}" غير متوفرة برابط مباشر حالياً.`);
                return;
            }

            // تحويل رابط المشاركة (view) إلى رابط التضمين (preview)
            // نستخدم التعبير العادي لضمان استبدال أي جزء بعد /d/FILE_ID/ إما بـ /preview
            const embedLink = book.link.replace(/(\/d\/[a-zA-Z0-9_-]+)(\/.*)?/, '$1/preview');
            
            // تحديث عنوان النافذة
            readerBookTitle.textContent = `${book.name} - ${window.currentStageName}`;
            
            // تعيين رابط التضمين في iframe
            bookIframe.src = embedLink;

            // **التعديل لحل مشكلة 404/الأذونات المحتملة في الـ iframe**
            // يتم فتح الرابط في نافذة جديدة إذا استغرق تحميل الـ iframe وقتاً طويلاً كبديل.
            bookIframe.onload = function() {
                // قد لا يعمل هذا الحدث دائماً مع روابط خارجية، لكن لضمان عمل الرابط
            };
            
            // احتياط: فتح الرابط مباشرة في نافذة جديدة في حالة عدم تحميل الـ iframe بشكل صحيح
            // نفتح نافذة جديدة بعد فترة زمنية قصيرة كحل احتياطي للروابط التي قد لا تُفتح في وضع التضمين
            setTimeout(() => {
                // إذا لم يتم تحميل الـ iframe أو كانت هناك مشكلة في العرض، نفتح الرابط في نافذة جديدة
                // هذا يضمن أن المستخدم يستطيع الوصول للمادة حتى لو فشل القارئ الداخلي
                const originalLink = book.link.replace('/view?usp=drivesdk', '/view?usp=sharing');
                bookIframe.onerror = function() {
                    alert(`فشل تحميل القارئ الرقمي. سيتم فتح المادة "${book.name}" في نافذة متصفح جديدة.`);
                    window.open(originalLink, '_blank', 'noopener,noreferrer');
                };

                // إعادة تعيين src لإعادة محاولة التحميل أو لتفعيل onerror
                bookIframe.src = bookIframe.src; 
                
            }, 3000); 


            // فتح النافذة المنبثقة للقارئ
            openModal('bookReader');
        }


        // دالة تبديل الوضع الليلي/النهاري (استخدام رمز الإيموجي)
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            if (isDarkMode) {
                localStorage.setItem('theme', 'dark');
                modeIcon.textContent = '☀️';
            } else {
                localStorage.setItem('theme', 'light');
                modeIcon.textContent = '🌙';
            }
            
            // إعادة تطبيق الألوان المخصصة عند تغيير الوضع إذا كانت موجودة
            applySavedColors();
            document.body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--background-body');
        }

        function updateCustomColors() {
            const primary = document.getElementById('primaryColorPicker').value;
            const bg = document.getElementById('bgColorPicker').value;
            const text = document.getElementById('textColorPicker').value;

            document.documentElement.style.setProperty('--primary-color', primary);
            document.documentElement.style.setProperty('--background-app', bg);
            document.documentElement.style.setProperty('--text-color', text);

            // حفظ الألوان في localStorage
            const colors = { primary, bg, text };
            localStorage.setItem('customColors', JSON.stringify(colors));
        }

        function applySavedColors() {
            const savedColors = localStorage.getItem('customColors');
            if (savedColors) {
                const { primary, bg, text } = JSON.parse(savedColors);
                document.documentElement.style.setProperty('--primary-color', primary);
                document.documentElement.style.setProperty('--background-app', bg);
                document.documentElement.style.setProperty('--text-color', text);
                
                // تحديث قيم الـ pickers
                if(document.getElementById('primaryColorPicker')) {
                    document.getElementById('primaryColorPicker').value = primary;
                    document.getElementById('bgColorPicker').value = bg;
                    document.getElementById('textColorPicker').value = text;
                }
            } else {
                // إذا لم تكن هناك ألوان محفوظة، نأخذ القيم الافتراضية من الـ CSS
                const style = getComputedStyle(document.documentElement);
                if(document.getElementById('primaryColorPicker')) {
                    document.getElementById('primaryColorPicker').value = rgbToHex(style.getPropertyValue('--primary-color').trim());
                    document.getElementById('bgColorPicker').value = rgbToHex(style.getPropertyValue('--background-app').trim());
                    document.getElementById('textColorPicker').value = rgbToHex(style.getPropertyValue('--text-color').trim());
                }
            }
        }

        function resetColors() {
            localStorage.removeItem('customColors');
            location.reload(); // إعادة تحميل لتطبيق القيم الافتراضية من CSS
        }

        // دالة مساعدة لتحويل RGB إلى Hex لمدخلات الألوان
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#6366f1'; // قيمة افتراضية
            const r = parseInt(match[1]);
            const g = parseInt(match[2]);
            const b = parseInt(match[3]);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // ===========================================
        // ==  دالة محاكاة رد الذكاء الاصطناعي (جديدة)  ==
        // ===========================================

        function getAIResponse() {
            const prompt = document.getElementById('ai-prompt-input').value.trim();
            const responseArea = document.getElementById('ai-response-area');
            const responseText = document.getElementById('ai-response-text');

            if (prompt === "") {
                alert("الرجاء كتابة سؤالك أولاً!");
                return;
            }

            // إظهار منطقة الرد وتحديث النص إلى 'جاري التفكير...'
            responseArea.style.display = 'block';
            responseText.innerHTML = 'جاري التفكير في إجابتك... يرجى الانتظار <span style="font-weight: 900;">(محاكاة)</span>';

            // محاكاة تأخير الرد
            setTimeout(() => {
                let simulatedResponse = '';
                
                // إضافة ردود أكثر تفصيلاً ومخصصة للمواد
                if (prompt.includes('نظرية') || prompt.includes('اشرح') || prompt.includes('قانون أوم')) {
                    simulatedResponse = 'قانون أوم (Ohm\'s Law) هو أساس الهندسة الكهربائية، ينص على أن **التيار (I)** المار في موصل يتناسب طرديًا مع **فرق الجهد (V)** وعكسيًا مع **المقاومة (R)**. الصيغة هي: $V = I \\times R$';
                } else if (prompt.includes('المايكروكونترولر')) {
                    simulatedResponse = 'المايكروكونترولر (Microcontroller) هو حاسوب متكامل صغير الحجم مدمج على شريحة واحدة. يُستخدم في قسم الإلكترونيك للتحكم بأجهزة معينة، ويحتوي على معالج (CPU)، ذاكرة، ووحدات إدخال/إخراج، مما يجعله مثاليًا لتطبيقات السيطرة والتحكم.';
                } else if (prompt.includes('التصوير') || prompt.includes('كاميرا') && prompt.includes('إعلام')) {
                    simulatedResponse = 'في قسم تكنولوجيا الإعلام، يُعد **عمق المجال (Depth of Field)** مفهوماً أساسياً. وهو المنطقة التي تظهر واضحة في الصورة (Sharp). التحكم به يتم عبر فتحة العدسة (Aperture): فتحة واسعة = عمق قليل، وفتحة ضيقة = عمق كبير.';
                } else if (prompt.includes('تشريح') || prompt.includes('أجهزة طبية')) {
                    simulatedResponse = 'الجهاز الطبي الأساسي الذي يجب معرفته هو جهاز تخطيط القلب (ECG). وظيفته تسجيل النشاط الكهربائي للقلب. وهو موضوع مهم في مادة الأجهزة الطبية التشخيصية.';
                } 
                 else if (prompt.includes('حل') && prompt.includes('رياضيات')) {
                    simulatedResponse = 'لحل المعادلات، تذكر دائماً عزل المتغير (x). إذا كنت تتعامل مع معادلات تفاضلية، تأكد من تحديد نوع المعادلة وطريقة الحل المناسبة لها (مثل فصل المتغيرات أو عامل التكامل).';
                }
                else {
                    simulatedResponse = 'عفواً، لا أستطيع الإجابة على هذا السؤال الآن، لكن يرجى العلم بأن هذه الميزة هي في مرحلة المحاكاة وستتوفر قريباً بشكل تفاعلي حقيقي. يمكنك التواصل مع الدعم الفني بالأسفل.';
                }
                
                responseText.innerHTML = simulatedResponse;
                
                // تنظيف مربع الإدخال
                document.getElementById('ai-prompt-input').value = '';
                
            }, 2000); // تأخير لمدة ثانيتين
        }
        
        // ===========================================
        // ==    دالة محاكاة البحث والتعديل (مضافة بناءً على طلبك)    ==
        // ===========================================

        const simulatedWarningsData = [
            { student: "أحمد سعيد", record: "غياب غير مبرر", date: "2025/11/01" },
            { student: "علي محمود", record: "مخالفة للزي المدرسي", date: "2025/10/28" },
            { student: "محمد جاسم", record: "غياب غير مبرر 3 أيام", date: "2025/10/25" },
            { student: "ايهم فراس جمال", record: "إنذار رقم 1 (تأخير)", date: "2025/10/10" },
        ];
        
        function updateSimulatedWarnings() {
             const sharedList = document.getElementById('shared-warnings-list');
             if (!sharedList) return;
             
             // مسح القائمة الحالية (لتجنب التكرار عند إعادة فتح الـ modal)
             sharedList.innerHTML = '';
             
             simulatedWarningsData.forEach(data => {
                  const listItem = document.createElement('li');
                  listItem.classList.add('stage-item');
                  listItem.innerHTML = `
                      <span>الطالب: ${data.student}</span>
                      <span style="color: #dc3545;">سجل: ${data.record} (تاريخ: ${data.date})</span>
                  `;
                  sharedList.appendChild(listItem);
             });
        }


        /**
         * دالة لمحاكاة البحث عن طالب بالاسم وفتح نافذة تعديل وهمية.
         * ملاحظة: تتطلب قاعدة بيانات حقيقية للتطبيق الفعلي.
         */
        function searchAndEditAbsences() {
            const studentNameInput = document.getElementById('admin-search-student-name');
            const studentName = studentNameInput.value.trim();
            const searchResultElement = document.getElementById('admin-search-result');
            const sharedList = document.getElementById('shared-warnings-list');

            // قائمة محاكاة للطلاب المسجلين
            const studentsDatabase = [
                "أحمد سعيد",
                "علي محمود",
                "سارة خليل",
                "محمد جاسم",
                "ايهم فراس جمال" // اسم المبرمج للتجربة
            ];

            if (studentName === "") {
                searchResultElement.textContent = "الرجاء إدخال اسم الطالب للبحث.";
                searchResultElement.style.display = 'block';
                return;
            }
            
            // إخفاء رسالة الخطأ قبل البحث
            searchResultElement.style.display = 'none';

            // التحقق من وجود الاسم (البحث يجب أن يكون متطابقاً للمحاكاة)
            const foundStudent = studentsDatabase.find(name => name === studentName);

            if (foundStudent) {
                // إذا تم العثور على الطالب، افتح نافذة تعديل وهمية
                const studentRecord = getStudentSimulatedRecord(foundStudent);
                
                const newWarning = prompt(`تم العثور على سجل الطالب: ${foundStudent}. 
سجله الحالي (محاكاة): ${studentRecord.warnings} إنذار و ${studentRecord.absences} يوم غياب.

أدخل الآن أي إنذار أو غياب جديد لهذا الطالب:`);

                if (newWarning !== null && newWarning.trim() !== "") {
                    // محاكاة إضافة السجل الجديد إلى القائمة المشتركة
                    const today = new Date().toLocaleDateString('ar-IQ', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    
                    const newRecord = { student: foundStudent, record: newWarning.trim(), date: today };
                    simulatedWarningsData.unshift(newRecord); // إضافة السجل الجديد في البداية
                    
                    updateSimulatedWarnings(); // إعادة رسم القائمة

                    alert(`تمت إضافة السجل بنجاح للطالب ${foundStudent}. هذا السجل سيظهر الآن للجميع في القائمة المشتركة.`);
                } else if (newWarning !== null) {
                     alert(`لم يتم إضافة سجل جديد للطالب ${foundStudent}.`);
                }
                
            } else {
                // إذا لم يتم العثور على الطالب
                searchResultElement.textContent = `لم يتم العثور على الطالب: "${studentName}". يرجى التأكد من كتابة الاسم بالكامل.`;
                searchResultElement.style.display = 'block';
            }
        }

        /**
         * دالة محاكاة للحصول على سجل طالب
         */
        function getStudentSimulatedRecord(name) {
            // بسيطة لغرض المحاكاة
            if (name.includes('أحمد سعيد')) return { warnings: 1, absences: 0 };
            if (name.includes('علي محمود')) return { warnings: 0, absences: 5 };
            if (name.includes('سارة خليل')) return { warnings: 1, absences: 0 };
            if (name.includes('ايهم فراس جمال')) return { warnings: 2, absences: 0 };
            return { warnings: 0, absences: 0 };
        }
        
        // تهيئة الوضع الليلي/النهاري وحالة الدخول عند التحميل 
        
        
        document.addEventListener('DOMContentLoaded', () => {
            const splash = document.getElementById('splash-screen');
            const progressBar = document.getElementById('main-progress-bar');
            
            // تهيئة الوضع الليلي فوراً
            let savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            
            // تطبيق الألوان المخصصة فوراً
            applySavedColors();

            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    hideSplash();
                } else {
                    width += 1;
                    if(progressBar) progressBar.style.width = width + '%';
                }
            }, 20);

            const hideSplash = () => {
                setTimeout(() => {
                    if(splash) {
                        splash.style.opacity = '0';
                        setTimeout(() => {
                            splash.style.visibility = 'hidden';
                        }, 500);
                    }
                }, 500);
            };


            
            const autoDarkModeCheckbox = document.getElementById('autoDarkMode');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                modeIcon.textContent = '☀️';
                if(autoDarkModeCheckbox) autoDarkModeCheckbox.checked = true;
            } else {
                modeIcon.textContent = '🌙';
                if(autoDarkModeCheckbox) autoDarkModeCheckbox.checked = false;
            }
            
            // تحقق من حالة الدخول
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            
            if (isLoggedIn) {
                loginScreen.style.display = 'none';
                mainAppContainer.style.display = 'block';
                
                // إظهار الأزرار الجانبية عند التحميل إذا كان مسجلاً دخوله
                if (modeToggle) { modeToggle.style.display = 'flex'; modeToggle.classList.remove('hidden'); }
                if (profileButton) { profileButton.style.display = 'flex'; profileButton.classList.remove('hidden'); }
                if (supportFab) { supportFab.style.display = 'flex'; supportFab.classList.remove('hidden'); }
                
                updateProfileModal();
                loadProfilePicture(); // **تمت الإضافة: تحميل الصورة الشخصية عند التحميل**
                populateAvatars(); // **تمت الإضافة: ملء شبكة الصور الجاهزة عند التحميل**
            } else {
                loginScreen.style.display = 'block';
                mainAppContainer.style.display = 'none';
                
                // التأكد من إخفاء الأزرار عند شاشة الدخول
                if (modeToggle) modeToggle.style.display = 'none';
                if (profileButton) profileButton.style.display = 'none';
                if (supportFab) supportFab.style.display = 'none';
                const bottomNav = document.getElementById('bottom-nav');
                if (bottomNav) bottomNav.style.display = 'none';
            }
            
            // تهيئة قائمة الأقسام عند التحميل لأول مرة
            if (sectionsContainer) {
                 populateSections();
            }
            
            // تهيئة قائمة الانذارات
            updateSimulatedWarnings();
            
            // **تمت الإضافة: تهيئة الوضع الليلي/النهاري عند التحميل**
            if (autoDarkModeCheckbox) {
                autoDarkModeCheckbox.checked = savedTheme === 'dark';
            }
        });

        // إغلاق النافذة عند النقر خارجها
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }
        
        // ربط زر تبديل الوضع الخارجي بدالة التبديل
        if (modeToggle) modeToggle.addEventListener('click', toggleDarkMode);
        
        // ربط حقل البحث في نافذة الإدارة بحدث الإدخال
        const adminSearchInput = document.getElementById('admin-search-student-name');
        if (adminSearchInput) {
            adminSearchInput.addEventListener('keyup', (event) => {
                if (event.keyCode === 13) {
                    searchAndEditAbsences();
                }
            });
        }
        
        // ربط حقل البحث الرئيسي بحدث الإدخال
        if (mainSearchInput) {
            mainSearchInput.addEventListener('input', syncSearchInput);
        }
        
        // ربط حقل البحث في المتصفح بحدث الإدخال
        if (browserSearchInput) {
            browserSearchInput.addEventListener('input', filterBrowserContent);
        }
        
        // **تمت الإضافة: ربط زر تبديل الوضع الخارجي بدالة التبديل**
        if (modeToggle) modeToggle.addEventListener('click', toggleDarkMode);

        // ===========================================
        // =    وظائف الآلة الحاسبة                  =
        // ===========================================

        function appendToCalc(value) {
            const display = document.getElementById('calc-display');
            
            // منع إدخال عمليات متتالية
            if (['+', '-', '*', '/'].includes(value)) {
                const lastChar = display.value[display.value.length - 1];
                if (['+', '-', '*', '/'].includes(lastChar)) {
                    return;
                }
            }
            
            display.value += value;
        }

        function clearCalc() {
            const display = document.getElementById('calc-display');
            display.value = '';
        }

        function deleteLastChar() {
            const display = document.getElementById('calc-display');
            display.value = display.value.slice(0, -1);
        }

        function calculateResult() {
            const display = document.getElementById('calc-display');
            try {
                if (display.value === '') {
                    return;
                }
                
                // التحقق من العمليات الصحيحة
                const expression = display.value.replace(/÷/g, '/').replace(/×/g, '*').replace(/−/g, '-');
                
                // تقييم العملية الحسابية
                const result = Function('"use strict"; return (' + expression + ')')();
                
                // تنسيق النتيجة
                if (Number.isFinite(result)) {
                    display.value = Math.round(result * 100000000) / 100000000;
                } else {
                    display.value = 'خطأ';
                }
            } catch (error) {
                display.value = 'خطأ في الصيغة';
                setTimeout(() => {
                    display.value = '';
                }, 2000);
            }
        }

        // ===========================================
        // =    وظائف سجل الملاحظات                 =
        // ===========================================

        function loadNotes() {
            const savedNotes = localStorage.getItem('notes');
            if (savedNotes) {
                return JSON.parse(savedNotes);
            }
            return [];
        }

        function saveNotes(notes) {
            localStorage.setItem('notes', JSON.stringify(notes));
        }

        function addNote() {
            const titleInput = document.getElementById('note-title');
            const contentInput = document.getElementById('note-content');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!title || !content) {
                alert('يرجى ملء عنوان الملاحظة والمحتوى');
                return;
            }
            
            const note = {
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('ar-SA')
            };
            
            let notes = loadNotes();
            notes.unshift(note);
            
            saveNotes(notes);
            
            titleInput.value = '';
            contentInput.value = '';
            
            displayNotes();
            
            alert('تم حفظ الملاحظة بنجاح!');
        }

        function displayNotes() {
            const notes = loadNotes();
            const notesList = document.getElementById('notes-list');
            const emptyMessage = document.getElementById('empty-notes');
            
            notesList.innerHTML = '';
            
            if (notes.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                
                notes.forEach(note => {
                    const noteItem = document.createElement('li');
                    noteItem.style.cssText = 'background-color: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-right: 4px solid var(--primary-color);';
                    
                    noteItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--primary-color); margin-bottom: 8px; margin-top: 0;">${note.title}</h4>
                                <p style="color: var(--text-color); margin: 8px 0; white-space: pre-wrap; word-wrap: break-word;">${note.content}</p>
                                <small style="color: #999; display: block; margin-top: 8px;">📅 ${note.date}</small>
                            </div>
                            <button onclick="deleteNote(${note.id})" style="background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 700; margin-right: 10px;">حذف</button>
                        </div>
                    `;
                    
                    notesList.appendChild(noteItem);
                });
            }
        }

        function deleteNote(noteId) {
            if (confirm('هل أنت متأكد من حذف هذه الملاحظة؟')) {
                let notes = loadNotes();
                notes = notes.filter(note => note.id !== noteId);
                saveNotes(notes);
                displayNotes();
            }
        }


    // --- منطق ميزة التدريب على الرسم الهندسي ---
    let canvas, ctx;
    let isDrawing = false;
    let startX, startY;
    let currentX, currentY;
    let tSquareY = 100;
    let autoCorrect = true;

    function initDrawingBoard() {
        canvas = document.getElementById('drawingCanvas');
        if (!canvas) return;
        ctx = canvas.getContext('2d');
        
        // ضبط الحجم
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        
        // دعم اللمس
        canvas.addEventListener('touchstart', (e) => { 
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousedown", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("mousemove", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }, { passive: false });
        
        canvas.addEventListener('touchend', (e) => {
            const mouseEvent = new MouseEvent("mouseup", {});
            canvas.dispatchEvent(mouseEvent);
        }, { passive: false });
    }

    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        
        // الالتزام بالمسطرة T إذا كانت قريبة
        if (Math.abs(startY - tSquareY) < 25) {
            startY = tSquareY;
        }
    }

    function draw(e) {
        const rect = canvas.getBoundingClientRect();
        const mouseY = e.clientY - rect.top;
        
        if (!isDrawing) {
            // تحريك المسطرة
            if (mouseY > 0 && mouseY < canvas.height) {
                tSquareY = mouseY;
                document.getElementById('tSquare').style.top = tSquareY + 'px';
            }
            return;
        }
        
        currentX = e.clientX - rect.left;
        currentY = e.clientY - rect.top;
    }

    function stopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;

        // التصحيح التلقائي
        if (autoCorrect) {
            // تصحيح أفقي
            if (Math.abs(currentY - startY) < 30) {
                currentY = startY;
            }
            // تصحيح عمودي
            else if (Math.abs(currentX - startX) < 30) {
                currentX = startX;
            }
        }

        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
    }

    function clearBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function toggleAutoCorrect() {
        autoCorrect = !autoCorrect;
        const btn = document.getElementById('toggleCorrectBtn');
        btn.textContent = autoCorrect ? 'التصحيح: مفعل' : 'التصحيح: معطل';
        btn.style.backgroundColor = autoCorrect ? 'var(--primary-color)' : '#777';
    }

    // ========================================
    // دوال التحكم بنافذة تدريب الرسم المنبثقة
    // ========================================

    /**
     * فتح نافذة ملاحظة تدريب الرسم
     */
    function openDrawingTrainingModal() {
        const modal = document.getElementById('drawingTrainingModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // منع التمرير خلف النافذة
    }

    /**
     * إغلاق نافذة ملاحظة تدريب الرسم
     */
    function closeDrawingTrainingModal() {
        const modal = document.getElementById('drawingTrainingModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto'; // استعادة التمرير
    }

    /**
     * إغلاق النافذة عند الضغط خارجها
     */
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('drawingTrainingModal');
        
        if (modal) {
            modal.addEventListener('click', function(event) {
                // إذا تم الضغط على خلفية النافذة (وليس على المحتوى)
                if (event.target === modal) {
                    closeDrawingTrainingModal();
                }
            });
        }
    });

    /**
     * دعم لوحة المفاتيح - إغلاق النافذة بالضغط على Escape
     */
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeDrawingTrainingModal();
        }
    });
        
        // ===========================================
        // ==        وظيفة الإرسال إلى تليجرام        ==
        // ===========================================
        function sendToTelegram() {
            sendToTelegramBot();
        }

        // ===========================================
        // ==   إرسال التقييمات إلى بوت تليجرام تلقائياً  ==
        // ===========================================
        
        const TELEGRAM_BOT_TOKEN = '7870054673:AAEkjncKhwEk0x-c9OGg2-tj951AO2NTpyY';
        const TELEGRAM_USER_ID = '6048176665'; // تم التحديث للايدي المطلوب
        
        // دالة للحصول على Chat ID من اليوزر نيم
        async function getChatIdFromUsername(username) {
            try {
                // نحاول الحصول على معرف الحساب من خلال API تليجرام
                // في الواقع، سنستخدم طريقة بديلة: إرسال رسالة مباشرة عبر رابط الملف الشخصي
                return null; // سنستخدم الطريقة البديلة
            } catch (error) {
                console.error('خطأ في جلب Chat ID:', error);
                return null;
            }
        }
        
        // دالة الإرسال التلقائي إلى البوت
        function sendToTelegramBot() {
            const stars = document.querySelector('input[name="star"]:checked');
            const complaint = document.getElementById('complaintText').value;
            
            if (!stars && !complaint) {
                alert('يرجى اختيار تقييم أو كتابة شكوى أولاً');
                return;
            }
            
            const ratingValue = stars ? stars.value : 'غير محدد';
            const userName = localStorage.getItem('studentName') || 'مستخدم غير معروف';
            const userStage = (localStorage.getItem('studentSectionKey') && localStorage.getItem('studentStageNumber')) ? `${vocationalSections[localStorage.getItem('studentSectionKey')].name} - ${stageNames[localStorage.getItem('studentStageNumber')]}` : 'غير محدد';
            const timestamp = new Date().toLocaleString('ar-IQ');
            
            // تجهيز الرسالة
            let message = `🌟 تقييم جديد للتطبيق 🌟\n\n`;
            message += `👤 المستخدم: ${userName}\n`;
            message += `🎓 المرحلة: ${userStage}\n`;
            message += `⭐ التقييم: ${ratingValue} من 5 نجوم\n`;
            message += `📅 التاريخ والوقت: ${timestamp}\n\n`;
            message += `📝 الشكوى/الاقتراح:\n${complaint || 'لا يوجد نص إضافي'}`;
            
            // إرسال الرسالة عبر API تليجرام
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            // محاولة إرسال الرسالة إلى المستخدم مباشرة عبر username
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: TELEGRAM_USER_ID, // سيتم محاولة استخدام username
                    text: message,
                    parse_mode: 'HTML'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log('✅ تم إرسال التقييم بنجاح');
                    showSuccessMessage('شكراً لتقييمك! تم إرسال الرسالة بنجاح.');
                    
                    // إغلاق النافذة ومسح البيانات
                    closeModal('ratingModal');
                    document.getElementById('complaintText').value = '';
                    if (stars) stars.checked = false;
                    
                    // حفظ أن المستخدم قيّم التطبيق
                    localStorage.setItem('hasRated', 'true');
                } else {
                    console.error('❌ خطأ في الإرسال:', data.description);
                    showErrorMessage('حدث خطأ في الإرسال. يرجى المحاولة لاحقاً.');
                }
            })
            .catch(error => {
                console.error('❌ خطأ في الاتصال:', error);
                showErrorMessage('خطأ في الاتصال بالخادم. يرجى التحقق من الإنترنت.');
            });
        }
        
        // دالة لعرض رسالة النجاح
        function showSuccessMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50, #45a049);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                z-index: 3000;
                font-weight: 700;
                animation: slideIn 0.3s ease;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }
        
        // دالة لعرض رسالة الخطأ
        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f44336, #da190b);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
                z-index: 3000;
                font-weight: 700;
                animation: slideIn 0.3s ease;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }
        
        // إضافة أنيميشن الشرائح
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // دالة الظهور التلقائي لنافذة التقييم بعد تسجيل الدخول
        function showRatingModalAutomatically() {
            // التحقق من أن المستخدم لم يقيّم من قبل
            const hasRated = localStorage.getItem('hasRated');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            
            if (isLoggedIn && !hasRated) {
                // تأخير الظهور قليلاً لتحسين تجربة المستخدم
                setTimeout(() => {
                    openModal('ratingModal');
                }, 1500);
            }
        }
        
        // استدعاء الدالة عند تحميل الصفحة
        window.addEventListener('load', showRatingModalAutomatically);
</script>

    <!-- نافذة التدريب على الرسم الهندسي -->
    <div id="drawingTraining" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary-color); margin: 0;">تدريب الرسم الهندسي</h2>
                <button onclick="closeModal('drawingTraining')" style="background: none; font-size: 1.5rem; color: var(--text-color);">✕</button>
            </div>
            
            <div class="drawing-board-container">
                <div id="tSquare" class="t-square"></div>
                <canvas id="drawingCanvas"></canvas>
            </div>
            
            <div class="drawing-controls">
                <button class="draw-btn" onclick="clearBoard()" style="background-color: #dc3545;">مسح اللوحة</button>
                <button id="toggleCorrectBtn" class="draw-btn" onclick="toggleAutoCorrect()">التصحيح: مفعل</button>
                <button class="draw-btn" onclick="alert('استخدم المسطرة T للرسم الأفقي الدقيق. القلم سيصحح نفسه تلقائياً عند الخطأ.')">تعليمات</button>
            </div>
            
            <p style="margin-top: 15px; font-size: 0.9rem; color: #666; text-align: center;">
                * حرك الماوس لتغيير موقع مسطرة T. ارسم بالقرب منها للحصول على خطوط أفقية مثالية.
            </p>
        </div>
    </div>

    <!-- النافذة المنبثقة لملاحظة تدريب الرسم -->
    <div class="drawing-training-modal" id="drawingTrainingModal">
        <div class="drawing-training-modal-content">
            <!-- زر الإغلاق -->
            <button class="drawing-training-modal-close" onclick="closeDrawingTrainingModal()">&times;</button>

            <!-- رأس النافذة -->
            <div class="drawing-training-modal-header">
                <span class="icon">📐</span>
                <h2>تدريب الرسم الهندسي</h2>
                <p>ملاحظات مهمة قبل البدء</p>
            </div>

            <!-- محتوى النافذة -->
            <div class="drawing-training-modal-body">
                <!-- قسم معلومات المدرسة -->
                <div class="drawing-training-section">
                    <h3>
                        <span class="section-icon">👨‍🏫</span>
                        مُدرسة المادة
                    </h3>
                    <div class="instructor-name">
                        المهندسة: ضحى عواد خلف
                    </div>
                </div>

                <!-- قسم الأدوات المطلوبة -->
                <div class="drawing-training-section">
                    <h3>
                        <span class="section-icon">🛠️</span>
                        الأدوات والمستلزمات المطلوبة
                    </h3>
                    <p>يجب توفير الأدوات التالية قبل بدء التدريب:</p>
                    
                    <table class="tools-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الأداة</th>
                                <th>الوصف</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="tool-number">1</td>
                                <td class="tool-name">بورد رسم</td>
                                <td>لوحة الرسم - سطح عمل مستوٍ وثابت ومناسب للرسم الهندسي</td>
                            </tr>
                            <tr>
                                <td class="tool-number">2</td>
                                <td class="tool-name">مسطرة حرف T</td>
                                <td>أداة أساسية لرسم الخطوط الأفقية المتوازية والعمودية بدقة عالية</td>
                            </tr>
                            <tr>
                                <td class="tool-number">3</td>
                                <td class="tool-name">مسطرة دوائر</td>
                                <td>قالب الدوائر - لتسهيل رسم الدوائر والأقواس بأحجام مختلفة</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- تنبيه مهم -->
                <div class="important-note">
                    <p>
                        <span class="note-icon">⚠️</span>
                        <strong>تنبيه مهم:</strong> تأكد من توفير جميع الأدوات المذكورة أعلاه قبل الدخول إلى الجلسة التدريبية لضمان أقصى استفادة من التدريب.
                    </p>
                </div>
            </div>

            <!-- تذييل النافذة -->
            <div class="drawing-training-modal-footer">
                <button onclick="closeDrawingTrainingModal()">فهمت - ابدأ التدريب</button>
            </div>
        </div>
    </div>

    <!-- نافذة التقييم والشكاوى -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-button" onclick="closeModal('ratingModal')">&times;</span>
                <h2>تقييم التطبيق والشكاوى</h2>
            </div>
            <div class="rating-container">
                <p style="margin-bottom: 15px; font-weight: 700;">ما هو تقييمك للتطبيق؟</p>
                <div class="stars">
                    <input type="radio" name="star" id="star5" value="5"><label for="star5"></label>
                    <input type="radio" name="star" id="star4" value="4"><label for="star4"></label>
                    <input type="radio" name="star" id="star3" value="3"><label for="star3"></label>
                    <input type="radio" name="star" id="star2" value="2"><label for="star2"></label>
                    <input type="radio" name="star" id="star1" value="1"><label for="star1"></label>
                </div>
                
                <p style="margin-bottom: 10px; font-weight: 700; text-align: right;">اكتب شكواك أو اقتراحك هنا:</p>
                <textarea id="complaintText" class="complaint-textarea" placeholder="أخبرنا برأيك أو مشكلتك..."></textarea>
                
                <button class="send-btn" onclick="sendToTelegram()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    إرسال التقييم
                </button>
                
                <p style="margin-top: 15px; font-size: 0.8rem; color: #888;">سيتم توجيهك إلى تليجرام لإرسال الرسالة</p>
            </div>
        </div>
    </div>




    <!-- منبه وقت القراءة -->
    <div class="reading-timer" id="reading-timer">
        <div class="timer-header">
            <span>⏱️ وقت القراءة</span>
            <button class="close-timer" onclick="stopReadingTimer()">×</button>
        </div>
        <div class="timer-display" id="timer-display">00:00:00</div>
        <div class="timer-stats">
            <div>الدقائق: <span id="timer-minutes">0</span></div>
            <div>الإشعارات: <span id="timer-notifications">0</span></div>
        </div>
        <div class="timer-controls">
            <button class="timer-btn" id="pause-btn" onclick="toggleReadingTimer()">إيقاف</button>
            <button class="timer-btn" onclick="resetReadingTimer()">إعادة</button>
        </div>
    </div>

    <script>
        // متغيرات منبه القراءة
        let readingTimerInterval = null;
        let readingTimerSeconds = 0;
        let readingTimerRunning = false;
        let readingNotificationCount = 0;
        let lastNotificationMinute = 0;
        
        const readingTimer = document.getElementById('reading-timer');
        const timerDisplay = document.getElementById('timer-display');
        const timerMinutes = document.getElementById('timer-minutes');
        const timerNotifications = document.getElementById('timer-notifications');
        const pauseBtn = document.getElementById('pause-btn');
        const bottomNav = document.getElementById('bottom-nav');

        // بدء منبه القراءة عند فتح كتاب
        function startReadingTimer(bookTitle = 'الكتاب') {
            if (!readingTimerRunning) {
                readingTimerRunning = true;
                readingTimerSeconds = 0;
                readingNotificationCount = 0;
                lastNotificationMinute = 0;
                readingTimer.classList.add('active');
                pauseBtn.textContent = 'إيقاف';
                
                alert('🎓 بدأت قراءة: ' + bookTitle);
                
                readingTimerInterval = setInterval(() => {
                    readingTimerSeconds++;
                    updateTimerDisplay();
                    
                    const currentMinute = Math.floor(readingTimerSeconds / 60);
                    if (currentMinute > lastNotificationMinute && currentMinute % 5 === 0) {
                        readingNotificationCount++;
                        lastNotificationMinute = currentMinute;
                        timerNotifications.textContent = readingNotificationCount;
                        alert('✅ رائع! لقد قرأت لمدة ' + currentMinute + ' دقيقة');
                    }
                }, 1000);
            }
        }

        // تحديث عرض المؤقت
        function updateTimerDisplay() {
            const hours = Math.floor(readingTimerSeconds / 3600);
            const minutes = Math.floor((readingTimerSeconds % 3600) / 60);
            const seconds = readingTimerSeconds % 60;
            
            const timeString = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            timerDisplay.textContent = timeString;
            timerMinutes.textContent = minutes;
        }

        // إيقاف/استئناف المؤقت
        function toggleReadingTimer() {
            if (readingTimerRunning) {
                clearInterval(readingTimerInterval);
                readingTimerRunning = false;
                pauseBtn.textContent = 'استئناف';
            } else {
                readingTimerRunning = true;
                pauseBtn.textContent = 'إيقاف';
                readingTimerInterval = setInterval(() => {
                    readingTimerSeconds++;
                    updateTimerDisplay();
                    
                    const currentMinute = Math.floor(readingTimerSeconds / 60);
                    if (currentMinute > lastNotificationMinute && currentMinute % 5 === 0) {
                        readingNotificationCount++;
                        lastNotificationMinute = currentMinute;
                        timerNotifications.textContent = readingNotificationCount;
                        alert('✅ رائع! لقد قرأت لمدة ' + currentMinute + ' دقيقة');
                    }
                }, 1000);
            }
        }

        // إعادة تعيين المؤقت
        function resetReadingTimer() {
            clearInterval(readingTimerInterval);
            readingTimerRunning = false;
            readingTimerSeconds = 0;
            readingNotificationCount = 0;
            lastNotificationMinute = 0;
            updateTimerDisplay();
            timerNotifications.textContent = '0';
            pauseBtn.textContent = 'إيقاف';
        }

        // إيقاف المؤقت والحفظ
        function stopReadingTimer() {
            clearInterval(readingTimerInterval);
            readingTimerRunning = false;
            readingTimer.classList.remove('active');
            
            const minutes = Math.floor(readingTimerSeconds / 60);
            alert('✅ انتهيت من القراءة! قرأت لمدة ' + minutes + ' دقيقة');
        }

        // التنقل بين الأقسام المعدلة
        function navigateBottomNav(section) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.bottom-nav-item').classList.add('active');
            
            switch(section) {
                case 'home':
                    // العودة للرئيسية أو إغلاق النوافذ المفتوحة
                    alert('🏠 العودة إلى الصفحة الرئيسية');
                    break;
                case 'assignments':
                    alert('📝 قسم الواجبات قريباً');
                    break;
                case 'notifications':
                    openNotificationsModal();
                    break;
            }
        }

        // تمت دمج وظائف تسجيل الدخول والخروج في الدوال الأساسية أعلاه لضمان استقرار التطبيق.

        // تعديل دالة openModal لبدء منبه القراءة
        const originalOpenModal = window.openModal;
        window.openModal = function(modalId) {
            if (originalOpenModal) {
                originalOpenModal(modalId);
            }
            if (modalId === 'bookReader') {
                startReadingTimer('الكتاب الحالي');
            }
        };
    </script>

</body>
</html>
